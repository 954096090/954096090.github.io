<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.lug.ustc.edu.cn/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="Silicon4的个人博客">
<meta property="og:type" content="website">
<meta property="og:title" content="Silicon4">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Silicon4">
<meta property="og:description" content="Silicon4的个人博客">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Silicon4">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>Silicon4</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Silicon4</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">科学，就是“偶尔能解答，常常在疑惑，总是在探寻”</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/21/%E5%88%A9%E7%94%A8debug%E9%AB%98%E9%80%9F%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/21/%E5%88%A9%E7%94%A8debug%E9%AB%98%E9%80%9F%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE/" itemprop="url">keil的debug小技巧</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-21T19:28:12+08:00">
                2020-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/STM32%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">STM32学习记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>调robomaster的6020电机时，需要把pid的数据导出来进行matlab仿真，那么问题就来了，该怎么导出呢，我当时立刻想到的方法是用串口打印数据，利用sprintf把pid的输入输出转成字符串，然后HAL_UART_Transmit()阻塞发送，在定时器中进行pid的计算以及数据的发送，但是效果却不尽人意。</p>
<p>因为电机是通过can总线协议，获取的是电压信息，-30000~30000范围，返回的数据是转速，角度，转矩和温度，调速度环，要看从精致到稳定的输入输出曲线，所以需要打印速度的pid三个信息，再来一个当前速度更加直观。但是，经过调试发现，频率过低，不能很好的与仿真的拟合曲线进行比较，而频率过高，串口发送会出现断层和乱码的情况。这时我就想到一个办法，那就是把数据保存在数组里，然后在线仿真，利用MDK的debug的功能，实现对数组内存的方便的访问。</p>
<p>这个方法不在于有多方便操作，而在于能够非常高频率的获取一些数据，而不会有通信问题而失去一些数据，或者因为系统外干扰而出现大量异常数据。</p>
<h3 id="操作流程"><a href="#操作流程" class="headerlink" title="操作流程"></a>操作流程</h3><p>废话不多说，开始走流程。首先保证你的keil版本至少是5以上，低版本的keil操作我不太清楚。<br>为了防止爆栈，把用于存数据的大数组放在函数外：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int16_t</span> buff[<span class="number">10000</span>]=&#123;<span class="number">0</span>&#125;;	<span class="comment">//int16_t取决于你的数据类型，这里也可以是包含多种信息结构体</span></span><br><span class="line"><span class="keyword">uint32_t</span> rxtx_p1 = <span class="number">0</span>; 		<span class="comment">//uint32_t取决于你的数组大小，比如8位的uint8_t就只能计数到255</span></span><br></pre></td></tr></table></figure>
<p>在循环或者中断中获取需要的数据并保存在这个数组中，比如我就交替保存速度和pid控制器输出：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">buff[rxtx_p1] = velocity;</span><br><span class="line">rxtx_p1++;</span><br><span class="line">buff[rxtx_p1] = output;</span><br><span class="line">rxtx_p1++;</span><br></pre></td></tr></table></figure><br>然后进入仿真，注意是连接硬件的在线仿真 ，不是虚拟仿真哟，选择J-link或者 ST-link进行仿真：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200721192328580.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>进入仿真界面后应该是下面这样，你的可能跟我的不一样，一般默认是不打开command和watchwindows视图的，在这里需要开启相应的视图，我们点击总菜单的view开启这两个视图：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200721192340197.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后在watchwindows中输入你定/义的存入数据的数组首地址，其实就z是数组名，我这里填buff，就出现了这个数组的具体数据，因为我开始初始化的是{0}，所以在开始仿真前数组元素都应该是0：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200721192351990.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后开始仿真，不要设置断点，就让程序正常跑起来，不出意外的话，定义的数组会慢慢被填满，当数组都存入数据后，或者你认为数据足够多了，停止运行，就可以看到数组内存入了你想要的数据，在我这里是pid的比例项和控制器输出：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200721192542595.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>之后就是想办法导出着一些数据了，利用KEIL自己的debug命令行和编译器，打开菜单栏debug中的Function Editor：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200721192557123.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后新建一个文件，它是空的，然后输入下面的代码：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FUNC <span class="keyword">void</span> <span class="title">displayvalues</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> idx;</span><br><span class="line"> </span><br><span class="line">  exec(<span class="string">"log &gt; MyValues.log"</span>);</span><br><span class="line">  <span class="keyword">for</span> (idx = <span class="number">0</span>; idx &lt; <span class="number">2000</span>; idx++) &#123;					<span class="comment">//2000是你的数组长度，这种方法最多导出2000个，后面自动省略了</span></span><br><span class="line">    <span class="built_in">printf</span> (<span class="string">"testarray[%d] = %u\n"</span>, idx, buff[idx]);	<span class="comment">//buff改成你自己的数组名</span></span><br><span class="line">  &#125;</span><br><span class="line">  exec(<span class="string">"log off"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>然后保存，保存你知道的地方，通常是工程目录或者KEIL的安装目录，然后打开它，点击编译，注意是这个Function Editor上面的编译，不是退出仿真去编译代码哦。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200721192617239.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后在command命令行输入这个函数：<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200721192631969.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"><br>然后回车，就发现这一串数组就全部打印到命令行窗口了，直接选择复制就OK了。<br><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200721192638475.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/17/arm_math/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/17/arm_math/" itemprop="url">STM32F4xx调用arm_math.h库</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-07-17T14:57:12+08:00">
                2020-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/STM32%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">STM32学习记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="为什么要用到这个库"><a href="#为什么要用到这个库" class="headerlink" title="为什么要用到这个库"></a>为什么要用到这个库</h3><p>这段时间在调Robomaster的电机，用的是大疆的F427主控，角度控制为了达到快速精准的效果，需要将PID的一个段写成非线性的方式，要用到”math.h”库当中的pow函数，但是使用KEIL自带的math.h对于单片机来说效率并不高，可能过多占用MCU，经了解，发现ARM提供了一个专为单片机设计的基于CM4内核的一个数学库，可以基于内核级别的数学运算优化，比传统的数学库速度快十到百倍左右，于是学习了一下调用这个函数库的一些步骤。</p>
<p>关于这个函数库的详细信息，请移步官网：<a href="https://www.keil.com/pack/doc/CMSIS/DSP/html/arm__math_8h.html" target="_blank" rel="noopener">https://www.keil.com/pack/doc/CMSIS/DSP/html/arm__math_8h.html</a></p>
<h3 id="开始配置"><a href="#开始配置" class="headerlink" title="开始配置"></a>开始配置</h3><p>废话不多说，我们先来看看存放Cortex内核核心外设使用的”core_cm4.h”文件：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined ( __CC_ARM )</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> defined __TARGET_FPU_VFP</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">if</span> defined (__FPU_PRESENT) &amp;&amp; (__FPU_PRESENT == 1U)</span></span><br><span class="line">      <span class="meta">#<span class="meta-keyword">define</span> __FPU_USED       1U</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">      <span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">"Compiler generates FPU instructions for a device without an FPU (check __FPU_PRESENT)"</span></span></span><br><span class="line">      <span class="meta">#<span class="meta-keyword">define</span> __FPU_USED       0U</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> __FPU_USED         0U</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="comment">//</span></span><br></pre></td></tr></table></figure>
<p>第一个__CC_ARM，是选择KEIL作为编译器的分支，因此我们<strong>需要在工程宏定义中添加__CC_ARM的宏定义</strong>。然后__TARGET_FPU_VFP也是必须要添加到宏定义中的。</p>
<p>再来说说__FPU_PRESENT和__FPU_USED这两个宏定义的作用吧，<strong>__FPU_PRESENT</strong>在编译时，编译系统用于判断该设备是否拥有FPU运算功能，也就是说，它作为编译是否加入FPU的总开关，因此我们<strong>需要加入这个宏，并且将它设为1</strong>。</p>
<p>但是仔细看看，stm32f427xx.h文件中已经有了这个宏定义，表示stm32f427系列是支持FPU功能的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CM4_REV                 0x0001U  <span class="comment">/*!&lt; Core revision r0p1                            */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MPU_PRESENT             1U       <span class="comment">/*!&lt; STM32F4XX provides an MPU                     */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __NVIC_PRIO_BITS          4U       <span class="comment">/*!&lt; STM32F4XX uses 4 Bits for the Priority Levels */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __Vendor_SysTickConfig    0U       <span class="comment">/*!&lt; Set to 1 if different SysTick Config is used  */</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __FPU_PRESENT             1U       <span class="comment">/*!&lt; FPU present				//需要注释掉</span></span></span><br></pre></td></tr></table></figure>
<p>但是编辑器显示core_cm4.h直接跳到#else里面了，也就是说编译器执行到这里不认为已经定义了__FPU_PRESENT，这是由于内核文件并不会包含中间驱动的宏定义的，所以我们需要在全局添加宏定义并且赋值为1：__FPU_PRESENT=1，然后编译时编译器会报错，因为重复定义了__FPU_PRESENT，<strong>所以我们把stm32f427xx.h中的__FPU_PRESENT注释掉</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//#define __FPU_PRESENT             1U       /*!&lt; FPU present</span></span><br></pre></td></tr></table></figure>
<p>这样就不会编译报错了，这样，内核编译时就会定义启动内核的FPU支持：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __FPU_USED       1U</span></span><br></pre></td></tr></table></figure>
<p>这样，编译部分的修改就已经完成了。之后就是<strong>添加头文件路径</strong>和源文件路径，这里就只需要添加一个头文件路径即可，整个函数库共用这几个头文件。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200717144636884.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="请添加图片描述"></p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200717144636879.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="请添加图片描述"></p>
<p>接下来添加需要的源文件，至于源文件需要哪些，就要看自己的需要了，一共有下面着这一些文件夹，把自己需要的加入工程即可，全部加进来编译时间翻倍，不建议全部添加，具体的函数功能打开源文件有英文描述，非常的清晰。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200717144636948.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="请添加图片描述"></p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200717144636866.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="请添加图片描述"></p>
<p>全部工作做好后，就可以编译了，然后会发现编译仍然报错，提示未定义的宏，到错误处，发现arm_math.h文件中有这么一段宏判断：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ARM_MATH_CM7)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"core_cm7.h"</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ARM_MATH_DSP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (ARM_MATH_CM4)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"core_cm4.h"</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ARM_MATH_DSP</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (ARM_MATH_CM3)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"core_cm3.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (ARM_MATH_CM0)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"core_cm0.h"</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ARM_MATH_CM0_FAMILY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (ARM_MATH_CM0PLUS)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"core_cm0plus.h"</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ARM_MATH_CM0_FAMILY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (ARM_MATH_ARMV8MBL)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"core_armv8mbl.h"</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">define</span> ARM_MATH_CM0_FAMILY</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined (ARM_MATH_ARMV8MML)</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"core_armv8mml.h"</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">if</span> (defined (__DSP_PRESENT) &amp;&amp; (__DSP_PRESENT == 1))</span></span><br><span class="line">    <span class="meta">#<span class="meta-keyword">define</span> ARM_MATH_DSP</span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">  <span class="meta">#<span class="meta-keyword">error</span> <span class="meta-string">"Define according the used Cortex core ARM_MATH_CM7, ARM_MATH_CM4, ARM_MATH_CM3, ARM_MATH_CM0PLUS, ARM_MATH_CM0, ARM_MATH_ARMV8MBL, ARM_MATH_ARMV8MML"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>而ARM_MATH_DMP又是作为arm_math库的开关，所以我们需要全局宏定义ARM_MATH_CM4来开启。</p>
<p>最后，引入”arm_math.h”头文件，然后再编译，通过。然后就可以使用自己添加进工程的arm版本的math函数了。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>经过前面的探索，我总结一下配置的步骤：</p>
<ul>
<li>添加全局宏：USE_HAL_DRIVER,STM32F427xx,__CC_ARM,<strong>TARGET_FPU_VFP,</strong>FPU_PRESENT,ARM_MATH_CM4</li>
<li><p>注释或者删除stm32f427xx.h中关于的__FPU_PRESENT定义</p>
</li>
<li><p>添加头文件路径</p>
</li>
<li>添加工程需要的math源文件，ARM已经帮我们按文件夹分好类了</li>
<li>在工程中引入头文件#include “arm_math.h”</li>
<li>开始使用库中的函数</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/21/%E7%BA%A2%E5%A4%96%E6%8E%A5%E6%94%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/21/%E7%BA%A2%E5%A4%96%E6%8E%A5%E6%94%B6/" itemprop="url">红外接收</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-21T02:48:30+08:00">
                2020-06-21
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <hr>
<p>title: STM32红外接收分析<br>date: 2020-06-18 00:45:12<br>tags:<br>categories: STM32学习记录</p>
<hr>
<h2 id="红外遥控原理分析"><a href="#红外遥控原理分析" class="headerlink" title="红外遥控原理分析"></a>红外遥控原理分析</h2><p>对于红外遥控，一般都不会陌生，我们身边就有很多采用红外遥控的设备，例如绝大多数的电视，空调，都使用的是红外遥控原理的遥控器，配上红外接收管接收遥控信号。</p>
<p>红外线（Infrared）是频率介于<a href="https://baike.baidu.com/item/微波/182739" target="_blank" rel="noopener">微波</a>与<a href="https://baike.baidu.com/item/可见光/1241853" target="_blank" rel="noopener">可见光</a>之间的<a href="https://baike.baidu.com/item/电磁波/102449" target="_blank" rel="noopener">电磁波</a>，波长在1mm到760<a href="https://baike.baidu.com/item/纳米" target="_blank" rel="noopener">纳米</a>（nm）之间，频率比红光低的不可见光。</p>
<p>红外发射端一般使用红外LED，接收端使用红外接收二极管，利用光电效应，经过滤波和功率放大，形成能够承载信号的数字量。红外线发射管在LED封装行业中主要有三个常用的波段，如下850NM、875NM、940NM。850NM波长的主要用于红外线监控设备，875NM主要用于医疗设备，940NM波段的主要用于红外线控制设备。一般的红外遥控器使用的发射管是940nm波长，当然，我们中学做实验在气垫导轨上用到的光电门，也是这种红外光，这个波长的红外光人眼虽然看不见，但是相机的CMOS传感器是可以捕捉到的，具体验证方法，用手机开启相机，对着空调或者电视遥控器的发射管，按下遥控器，就可以看见屏幕里粉色的灯珠。</p>
<p>再来谈一谈红外遥控的方式是怎么传递信息的。大多数用于遥控的红外信号，采用NEC编码的方式。将用于驱动红外LED的电平信号，经过调制，形成某个高频信号的幅度、相位、频率等参量变化的过程，用一个信号去装载另一个信号。比如我们的红外遥控信号要发送的时候，先经过38K调制，如图所示：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="http://www.elecfans.com/uploads/allimg/170803/1715185-1FP31P2101J.jpg" alt="红外遥控器通信原理_红外遥控器协议_红外通信对比无线通信的优势"></p>
<p>经过这样的调制信号，我们就可以用它来装载我们需要的信号。比如对于NEC编码，规定发射信号有以下4种：</p>
<ol>
<li>起始码：用于判断起始信号</li>
<li>逻辑0</li>
<li>逻辑1</li>
<li>重复码：如果遥控器有连按功能，那么发完一次完整的信号后，按键松开前都会循环发送重复码</li>
</ol>
<p>我们由于红外传输的是一种数字信号，所以我们可以使用脉宽调制（JPWM）的方式，用<strong>不同的电平时间</strong>区分这4种信息。具体的不同就是这样：</p>
<ol>
<li>起始码：9ms低电平 + 4.5ms高电平</li>
<li>逻辑0：   560us + 560us</li>
<li>逻辑1：   560us + 1680us</li>
<li>重复码 ：  9ms低电平 + 2.5ms高电平</li>
</ol>
<p>如果按照NEC编码的<strong>功能</strong>来区分，以正常的时序，就有以下几种码：</p>
<ol>
<li>起始码</li>
<li>用户地址码（8bit）+用户地址反码（8bit）</li>
<li>数据码（8bit）+数据反码（8bit）</li>
<li>如果连按，之后会一直发送重复码</li>
</ol>
<h2 id="器件准备"><a href="#器件准备" class="headerlink" title="器件准备"></a>器件准备</h2><ol>
<li>STM32核心板或开发板，有板载红外接收管最好</li>
<li>一个红外遥控器（可以用空调或者电视遥控器代替）</li>
<li>一个红外接收管，最好是带有放大电路的，但是不要使用带有解调芯片的。</li>
<li>如果可以，最好是有一个逻辑分析仪或者示波器，可以提前对未知的红外遥控设备进行直观的解码</li>
</ol>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200620204033923.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="准备的材料"></p>
<h2 id="程序编写"><a href="#程序编写" class="headerlink" title="程序编写"></a>程序编写</h2><p>程序编写分为2个部分，分别是接收程序和发送程序，为了学习标准的NEC编码，我们使用标准遥控器，先通过编写接收程序，来体验红外编码的时序，有一个直观的理解之后，再尝试编写发送代码。</p>
<p>红外接收有3个引脚，5V，GND，以及信号引脚，先将接收模块连接逻辑分析仪，注意不要忘了共地，打开逻辑分析仪，再软件中设置上升沿和下降沿捕获，然后按下遥控器（可以是空调遥控器，我这里用专用红外遥控器的数字1键演示），然后逻辑分析仪就会捕获到一次信号，如下图：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200620233324134.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="逻辑电平图"></p>
<p>这样，我们就得到了红外遥控器上按下数字1的红外信号，根据上面的原理分析，这个信号就很容易理解了：首先是一个<strong>起始码</strong>，有9ms低电平，4.5ms高电平，紧接着是<strong>8位地址码</strong>，这里是0（0000 0000）,相应的<strong>8位地址反码</strong>就是255（1111 1111），紧接着是<strong>8位数据码</strong>，这里是162（1010 0010），相应<strong>8位数据反码</strong>93（0101 1101），然后经过一段时间高电平，接收到了<strong>重复码</strong>，有9ms低电平和2.5ms高电平，如果按住不放，之后就一直循环接收到重复码。</p>
<p>是不是一目了然？其实对我来说，这是迫不得已，因为我买的遥控器，资料非常有限，只给了一个电气参数的PDF，编码表也没有，例程更没有，无奈我只能动用逻辑分析仪，弄清楚了每个按键的编码值，顺便分析了一下电平时间和时序，算是做一个铺垫吧。</p>
<p>我要在小车上用红外接收，需要用到的按键，有下面一些：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200621024633235.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="红外编码"></p>
<h3 id="接收程序思路分析"><a href="#接收程序思路分析" class="headerlink" title="接收程序思路分析"></a>接收程序思路分析</h3><p>NEC编码解码的实质，其实是对电平时间的精确读取，我不禁想到了超声波模块。对了！一切都是那么的熟悉，定时器的捕获模式，刚好满足这种需求。</p>
<ol>
<li>设置低电平捕获，一旦接收到信号，进入捕获中断，改为高电平捕获，捕捉到高电平时，读取计数值，再根据时基，就得到了低电平的时间，获取高电平时间的方法也是一样</li>
<li>然后根据时间的范围，设置一些标志位，来判断数据起始位，然后获取地址码，地址反码，数据码，数据反码</li>
<li>然后校验，将地址码与地址反码的取反进行比较，再与设定的地址码进行比较，如果都相等则表示地址数据无误，并且控制设备无误，继续下一步</li>
<li>将数据码与数据反码的取反进行比较，相等则表示数据无误，再赋值给需要接收键值的变量。</li>
</ol>
<p>由于我是应用在小车上的，本来是设计成蓝牙遥控，这样就可以拓展出红外遥控了，C8T6一共有4个定时器的资源，TIM1用于PWM模式，驱动两个电机，TIM2和TIM4用于读取2个AB相编码器，TIM3用于超声波模块的输入捕获，那么要想红外遥控，只能废掉超声波避障了。</p>
<h3 id="timer-c-amp-timer-h"><a href="#timer-c-amp-timer-h" class="headerlink" title="timer.c&amp;timer.h"></a>timer.c&amp;timer.h</h3><p>根据红外接收的工作特性，应该接收到一次低电平，程序进入中断，我们开始判断是否是起始位，因此，<strong>初始化</strong>程序应该配置为Input Capture<strong>输入捕获模式</strong>，捕获极性为<strong>低电平捕获</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"timer.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"delay.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef htim3;      <span class="comment">//定时器3句柄</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Remote_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    TIM_IC_InitTypeDef TIM3_CH3_IC_Initure;	<span class="comment">//定时器初始化句柄</span></span><br><span class="line">    </span><br><span class="line">    htim3.Instance=TIM3;                          <span class="comment">//选择定时器：定时器3</span></span><br><span class="line">    htim3.Init.Prescaler=(<span class="number">72</span><span class="number">-1</span>);                  <span class="comment">//预分频器：72分频,1M的计数频率,1um周期</span></span><br><span class="line">    htim3.Init.CounterMode=TIM_COUNTERMODE_UP;    <span class="comment">//计数方向：向上计数</span></span><br><span class="line">    htim3.Init.Period=<span class="number">10000</span>;                      <span class="comment">//自动装载值：最大计时10ms</span></span><br><span class="line">    htim3.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;<span class="comment">//时钟分频：不分频</span></span><br><span class="line">    HAL_TIM_IC_Init(&amp;htim3);						<span class="comment">//进行初始化</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化TIM1输入捕获参数</span></span><br><span class="line">    TIM3_CH3_IC_Initure.ICPolarity=TIM_ICPOLARITY_RISING;    <span class="comment">//捕获极性：上升沿捕获</span></span><br><span class="line">    TIM3_CH3_IC_Initure.ICSelection=TIM_ICSELECTION_DIRECTTI;<span class="comment">//交错映射：直接映射到TI3上</span></span><br><span class="line">    TIM3_CH3_IC_Initure.ICPrescaler=TIM_ICPSC_DIV1;          <span class="comment">//输入捕获分频：不分频</span></span><br><span class="line">    TIM3_CH3_IC_Initure.ICFilter=<span class="number">0x03</span>;                       <span class="comment">//硬件滤波：设置8个定时器时钟周期滤波</span></span><br><span class="line">    HAL_TIM_IC_ConfigChannel(&amp;htim3,&amp;TIM3_CH3_IC_Initure,TIM_CHANNEL_3);<span class="comment">//通道选择：配置TIM4通道3</span></span><br><span class="line">    HAL_TIM_IC_Start_IT(&amp;htim3,TIM_CHANNEL_3);   <span class="comment">//开始捕获TIM3的通道3</span></span><br><span class="line">    __HAL_TIM_ENABLE_IT(&amp;htim3,TIM_IT_UPDATE);   <span class="comment">//使能更新中断</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Input Capture 输入捕获MSP函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">    __HAL_RCC_TIM3_CLK_ENABLE();            <span class="comment">//使能TIM3时钟</span></span><br><span class="line">    __HAL_RCC_GPIOB_CLK_ENABLE();			<span class="comment">//开启GPIOB时钟</span></span><br><span class="line">	</span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_0;            <span class="comment">//PB0</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_AF_INPUT;  	<span class="comment">//复用输入</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLUP;          <span class="comment">//上拉</span></span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;<span class="comment">//高速</span></span><br><span class="line">    HAL_GPIO_Init(GPIOB,&amp;GPIO_Initure);</span><br><span class="line"></span><br><span class="line">    HAL_NVIC_SetPriority(TIM3_IRQn,<span class="number">1</span>,<span class="number">3</span>); 	<span class="comment">//设置中断优先级，抢占优先级1，子优先级3</span></span><br><span class="line">    HAL_NVIC_EnableIRQ(TIM3_IRQn);       	<span class="comment">//开启ITM4中断</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，我们实际上有两种中断，一种是捕获成功进入<strong>捕获中断</strong>，另一种未捕获，达到计数重装值，进入<strong>更新溢出中断</strong>，方便起见，在中断服务函数中写HAL库的中断处理总函数(HAL库就是香)，在函数内部会自动进入各自的回调函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HAL_TIM_IRQHandler(&amp;htim3);<span class="comment">//HAL库定时器处理函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于在处理过程中需要有各种标志的判断，定义一个储存状态的8位变量会方便许多：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//[7]:收到了引导码标志</span></span><br><span class="line"><span class="comment">//[6]:得到了一个按键的所有信息</span></span><br><span class="line"><span class="comment">//[5]:保留	</span></span><br><span class="line"><span class="comment">//[4]:标记上升沿是否已经被捕获								   </span></span><br><span class="line"><span class="comment">//[3:0]:溢出计时器</span></span><br><span class="line">u8 	RmtSta=<span class="number">0</span>;	<span class="comment">//状态标志变量</span></span><br></pre></td></tr></table></figure>
<p>然后，我们继续分析，起始码中的9ms低电平其实没有必要判断，作为一个触发的信号就好，因为我们完全可以通过后面的4.5ms<strong>高电平</strong>，就得到一个起始码，然后逻辑电平0和1的区别，也在于<strong>高电平</strong>的时间长短，甚至重复码的特征也是2.5ms的<strong>高电平</strong>，那么代码的主要思路就很确定了：<strong>上升沿捕获中断中设置计时起点，在下降沿捕获中断期间判断计数值，得到高电平持续的时间，就可以在下降沿中断期间做出判断，是起始码还是重复码，是逻辑1还是逻辑0。</strong></p>
<p>因此有必要设置一个存储计数值的变量，表示高电平时间，本质是读取CCR4寄存器，所以是16位：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u16 Dval;		<span class="comment">//上升沿期间,计数器增加的值</span></span><br></pre></td></tr></table></figure>
<p>再定义一个储存所有有效逻辑电平的变量，8+8+8+8一共32位：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u32 RmtRec=<span class="number">0</span>;	<span class="comment">//红外接收到的数据</span></span><br></pre></td></tr></table></figure>
<p>如果需要记录连按，那么就需要一个计数变量，一般情况不是必须的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">u8  RmtCnt=<span class="number">0</span>;	<span class="comment">//按键按下的次数</span></span><br></pre></td></tr></table></figure>
<p>接下来就是中断回调函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定时器更新（溢出）中断回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(htim-&gt;Instance==TIM3)</span><br><span class="line">	&#123;</span><br><span class="line"> 		<span class="keyword">if</span>(RmtSta&amp;<span class="number">0x80</span>)<span class="comment">//检测第[7]位，如果收到引导码</span></span><br><span class="line">		&#123;</span><br><span class="line">			RmtSta&amp;=~<span class="number">0X10</span>;						<span class="comment">//清零第[4]位,清除上升沿捕获标志</span></span><br><span class="line">			<span class="keyword">if</span>((RmtSta&amp;<span class="number">0X0F</span>)==<span class="number">0X00</span>)RmtSta|=<span class="number">1</span>&lt;&lt;<span class="number">6</span>;<span class="comment">//标记已经完成一次按键的键值信息采集</span></span><br><span class="line">			<span class="keyword">if</span>((RmtSta&amp;<span class="number">0X0F</span>)&lt;<span class="number">14</span>)RmtSta++;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				RmtSta&amp;=~(<span class="number">0x80</span>);<span class="comment">//清空起始标识</span></span><br><span class="line">				RmtSta&amp;=~(<span class="number">0x0F</span>);<span class="comment">//清空溢出计数器</span></span><br><span class="line">			&#125;						 	   	</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器输入捕获中断回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_CaptureCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span><span class="comment">//捕获中断发生时执行</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(htim-&gt;Instance==TIM3)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(DATA_PIN)<span class="comment">//读取引脚状态，如果引脚高电平，说明是上升沿捕获</span></span><br><span class="line">		&#123;</span><br><span class="line">			TIM_RESET_CAPTUREPOLARITY(&amp;htim3,TIM_CHANNEL_3);   					<span class="comment">//清除捕获极性</span></span><br><span class="line">			TIM_SET_CAPTUREPOLARITY(&amp;htim3,TIM_CHANNEL_3,TIM_ICPOLARITY_FALLING);<span class="comment">//配置捕获极性，设置为下降沿捕获</span></span><br><span class="line">			__HAL_TIM_SET_COUNTER(&amp;htim3,<span class="number">0</span>);		<span class="comment">//清空定时器计数值	  </span></span><br><span class="line">		  	RmtSta|=<span class="number">0X10</span>;							<span class="comment">//设置第[4]位，标记上升沿已经被捕获</span></span><br><span class="line">		&#125;<span class="keyword">else</span> <span class="comment">//下降沿捕获</span></span><br><span class="line">		&#123;</span><br><span class="line">			Dval=HAL_TIM_ReadCapturedValue(&amp;htim3,TIM_CHANNEL_3);<span class="comment">//读取输入捕获的计数值</span></span><br><span class="line">			TIM_RESET_CAPTUREPOLARITY(&amp;htim3,TIM_CHANNEL_3);   <span class="comment">//清除捕获极性</span></span><br><span class="line">			TIM_SET_CAPTUREPOLARITY(&amp;htim3,TIM_CHANNEL_3,TIM_ICPOLARITY_RISING);<span class="comment">//配置捕获极性，设置为上升沿捕获</span></span><br><span class="line">			<span class="keyword">if</span>(RmtSta&amp;<span class="number">0X10</span>)							<span class="comment">//完成一次上升沿捕获 </span></span><br><span class="line">			&#123;</span><br><span class="line"> 				<span class="keyword">if</span>(RmtSta&amp;<span class="number">0X80</span>)<span class="comment">//接收到了引导码</span></span><br><span class="line">				&#123;</span><br><span class="line">					</span><br><span class="line">					<span class="keyword">if</span>(Dval&gt;<span class="number">300</span>&amp;&amp;Dval&lt;<span class="number">800</span>)			<span class="comment">//收到逻辑0,560us</span></span><br><span class="line">					&#123;</span><br><span class="line">						RmtRec&lt;&lt;=<span class="number">1</span>;</span><br><span class="line">						RmtRec|=<span class="number">0</span>;   </span><br><span class="line">					&#125;<span class="keyword">else</span> <span class="keyword">if</span>(Dval&gt;<span class="number">1400</span>&amp;&amp;Dval&lt;<span class="number">1800</span>)	<span class="comment">//收到逻辑1,1680us</span></span><br><span class="line">					&#123;</span><br><span class="line">						RmtRec&lt;&lt;=<span class="number">1</span>;</span><br><span class="line">						RmtRec|=<span class="number">1</span>;</span><br><span class="line">					&#125;<span class="keyword">else</span> <span class="keyword">if</span>(Dval&gt;<span class="number">2200</span>&amp;&amp;Dval&lt;<span class="number">2600</span>)	<span class="comment">//收到重复码,2.5ms</span></span><br><span class="line">					&#123;</span><br><span class="line">						RmtCnt++; 					<span class="comment">//按键次数增加1次</span></span><br><span class="line">						RmtSta&amp;=~(<span class="number">0x0F</span>);			<span class="comment">//清空溢出计数器		</span></span><br><span class="line">					&#125;</span><br><span class="line"> 				&#125;<span class="keyword">else</span> <span class="keyword">if</span>(Dval&gt;<span class="number">4200</span>&amp;&amp;Dval&lt;<span class="number">4700</span>)		<span class="comment">//收到起始码,4.5ms</span></span><br><span class="line">				&#123;</span><br><span class="line">					RmtSta|=<span class="number">0x80</span>;					<span class="comment">//设置第[7]位，表示成功接收到了引导码</span></span><br><span class="line">					RmtCnt=<span class="number">0</span>;						<span class="comment">//清除按键次数计数器</span></span><br><span class="line">				&#125;						 </span><br><span class="line">			&#125;</span><br><span class="line">			RmtSta&amp;=~(<span class="number">0x10</span>);						<span class="comment">//清除上升沿捕获标志</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所有的操作我都打上了详细的注释，下面我按照正常接收一帧有效数据来过一遍这个时序，单片机如何读到数据，存入RmtRec变量中的：</p>
<ol>
<li><p>首先起始码，9ms低电平，由于是下降沿，不会触发中断，然后4.5ms高电平，触发中断，判断为上升沿捕获，标记上升沿捕获，然后重新设置下降沿捕获，计数值清零，这时便开始记录高电平的持续时间。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(DATA_PIN)<span class="comment">//读取引脚状态，如果引脚高电平，说明是上升沿捕获</span></span><br><span class="line">&#123;</span><br><span class="line">	TIM_RESET_CAPTUREPOLARITY(&amp;htim3,TIM_CHANNEL_3);   					<span class="comment">//清除捕获极性</span></span><br><span class="line">	TIM_SET_CAPTUREPOLARITY(&amp;htim3,TIM_CHANNEL_3,TIM_ICPOLARITY_FALLING);<span class="comment">//配置捕获极性，设置为下降沿捕获</span></span><br><span class="line">	__HAL_TIM_SET_COUNTER(&amp;htim3,<span class="number">0</span>);		<span class="comment">//清空定时器计数值	  </span></span><br><span class="line">	RmtSta|=<span class="number">0X10</span>;							<span class="comment">//设置第[4]位，标记上升沿已经被捕获</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>一旦捕获到下降沿，便重新设置上升沿捕获，然后读取CCR4寄存器，存入Dval变量，由于设置的是72分频，计数值就是1um的数量，判断这个变量的所在区间，就可以得到收到的是什么。如果是<strong>起始码</strong>，就把相应的起始码标志位置1。如果判断标志位<strong>已经收到起始码</strong>，就判断<strong>逻辑码</strong>和<strong>重复码</strong>。如果是<strong>逻辑码</strong>，就将Rec变量左移，如果是1，就进行与操作，如果是0，可以不操作，因为右移自动补0。如果是<strong>重复码</strong>，就把重复计数加1。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(RmtSta&amp;<span class="number">0X10</span>)							<span class="comment">//完成一次上升沿捕获 </span></span><br><span class="line">&#123;</span><br><span class="line"> 	<span class="keyword">if</span>(RmtSta&amp;<span class="number">0X80</span>)<span class="comment">//如果已经收到引导码</span></span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">if</span>(Dval&gt;<span class="number">300</span>&amp;&amp;Dval&lt;<span class="number">800</span>)			<span class="comment">//收到逻辑0,560us</span></span><br><span class="line">		&#123;</span><br><span class="line">			RmtRec&lt;&lt;=<span class="number">1</span>;</span><br><span class="line">			RmtRec|=<span class="number">0</span>;   </span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Dval&gt;<span class="number">1400</span>&amp;&amp;Dval&lt;<span class="number">1800</span>)	<span class="comment">//收到逻辑1,1680us</span></span><br><span class="line">		&#123;</span><br><span class="line">			RmtRec&lt;&lt;=<span class="number">1</span>;</span><br><span class="line">			RmtRec|=<span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(Dval&gt;<span class="number">2200</span>&amp;&amp;Dval&lt;<span class="number">2600</span>)	<span class="comment">//收到重复码,2.5ms</span></span><br><span class="line">		&#123;</span><br><span class="line">			RmtCnt++; 					<span class="comment">//按键次数增加1次</span></span><br><span class="line">			RmtSta&amp;=~(<span class="number">0x0F</span>);			<span class="comment">//清空溢出计数器		</span></span><br><span class="line">		&#125;</span><br><span class="line"> 	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(Dval&gt;<span class="number">4200</span>&amp;&amp;Dval&lt;<span class="number">4700</span>)		<span class="comment">//收到引导码,4.5ms</span></span><br><span class="line">	&#123;</span><br><span class="line">		RmtSta|=<span class="number">0x80</span>;					<span class="comment">//设置第[7]位，表示成功接收到了引导码</span></span><br><span class="line">		RmtCnt=<span class="number">0</span>;						<span class="comment">//清除按键次数计数器</span></span><br><span class="line">	&#125;						 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果超时，从逻辑分析仪的数据来看，只有一种可能，就是<strong>每次数据之间的上升沿时间会超过我设定的10ms自动重装时间，也就是说，会有下降沿中断无法达到，于是触发了溢出中断回调函数，这个中断就可以作为接收结束的标志</strong>，在里面进行标志位的复位操作即可。Sta变量的0-3位，作为计数位使用，可以计数0-15次，对于我的红外遥控器如果是连按的话，通常在15个重装时间150ms内会有重复码，如果15次还没有低电平出现，就视为松开了按键，需要清空起始标志和计数位，等待下一次按下按键。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定时器更新（溢出）中断回调函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(htim-&gt;Instance==TIM3)</span><br><span class="line">	&#123;</span><br><span class="line"> 		<span class="keyword">if</span>(RmtSta&amp;<span class="number">0x80</span>)<span class="comment">//检测第[7]位，如果收到引导码</span></span><br><span class="line">		&#123;</span><br><span class="line">			RmtSta&amp;=~<span class="number">0X10</span>;						<span class="comment">//清零第[5]位,清除上升沿捕获标志</span></span><br><span class="line">			<span class="keyword">if</span>((RmtSta&amp;<span class="number">0X0F</span>)==<span class="number">0X00</span>)RmtSta|=<span class="number">1</span>&lt;&lt;<span class="number">6</span>;<span class="comment">//标记已经完成一次按键的键值信息采集</span></span><br><span class="line">			<span class="keyword">if</span>((RmtSta&amp;<span class="number">0X0F</span>)&lt;<span class="number">14</span>)RmtSta++;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				RmtSta&amp;=~(<span class="number">0x80</span>);<span class="comment">//清空起始标识</span></span><br><span class="line">				RmtSta&amp;=~(<span class="number">0x0F</span>);<span class="comment">//清空溢出计数器</span></span><br><span class="line">			&#125;						 	   	</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>接下来，一共32位数据就存入了Rec变量中，由于存入数据时采用左移的方式，那么右移32-8=24位，与0xFF得到地址码，右移32-16=16位，得到地址反码，右移8位，得到数据码，直接与0xFF就是数据反码。然后，验证遥控用户码是否等于宏定义的地址码，并且取出从第24位开始的8位数据码，return返回，判断这个值，做相应的控制操作，就完成了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">u8 <span class="title">Remote_Scan</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;        </span><br><span class="line">	u8 sta=<span class="number">0</span>;       </span><br><span class="line">	u8 temp1,temp2;</span><br><span class="line">	<span class="keyword">if</span>(RmtSta&amp;(<span class="number">1</span>&lt;&lt;<span class="number">6</span>))<span class="comment">//得到一个按键的所有信息了</span></span><br><span class="line">	&#123; </span><br><span class="line">	    temp1=RmtRec&gt;&gt;<span class="number">24</span>;			<span class="comment">//得到地址码</span></span><br><span class="line">	    temp2=(RmtRec&gt;&gt;<span class="number">16</span>)&amp;<span class="number">0xff</span>;	<span class="comment">//得到地址反码 </span></span><br><span class="line"> 	    <span class="keyword">if</span>((temp1==(u8)~temp2)&amp;&amp;temp1==REMOTE_ID)<span class="comment">//检验遥控地址码,遥控器发送的地址码要和这里宏定义的相同才匹配 </span></span><br><span class="line">	    &#123; </span><br><span class="line">	        temp1=RmtRec&gt;&gt;<span class="number">8</span>;</span><br><span class="line">	        temp2=RmtRec; 	</span><br><span class="line">	        <span class="keyword">if</span>(temp1==(u8)~temp2)sta=temp1;<span class="comment">//键值正确	 </span></span><br><span class="line">		&#125;   </span><br><span class="line">		<span class="keyword">if</span>((sta==<span class="number">0</span>)||((RmtSta&amp;<span class="number">0X80</span>)==<span class="number">0</span>))<span class="comment">//按键数据错误/遥控已经没有按下了</span></span><br><span class="line">		&#123;</span><br><span class="line">		 	RmtSta&amp;=~(<span class="number">1</span>&lt;&lt;<span class="number">6</span>);<span class="comment">//清除接收到有效按键标识</span></span><br><span class="line">			RmtCnt=<span class="number">0</span>;		<span class="comment">//清除按键次数计数器</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="keyword">return</span> sta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_yaokong</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	u8 key;</span><br><span class="line">	key = Remote_Scan();</span><br><span class="line">	<span class="keyword">switch</span> (key)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">24</span>: Flag_Qian=<span class="number">1</span>,Flag_Hou=<span class="number">0</span>,Flag_Left=<span class="number">0</span>,Flag_Right=<span class="number">0</span>; <span class="keyword">break</span>;	<span class="comment">//前进</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">74</span>: Flag_Qian=<span class="number">0</span>,Flag_Hou=<span class="number">1</span>,Flag_Left=<span class="number">0</span>,Flag_Right=<span class="number">0</span>; <span class="keyword">break</span>;	<span class="comment">//后退</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">16</span>: Flag_Qian=<span class="number">0</span>,Flag_Hou=<span class="number">0</span>,Flag_Left=<span class="number">1</span>,Flag_Right=<span class="number">0</span>; <span class="keyword">break</span>;	<span class="comment">//左转</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">90</span>: Flag_Qian=<span class="number">1</span>,Flag_Hou=<span class="number">0</span>,Flag_Left=<span class="number">0</span>,Flag_Right=<span class="number">1</span>; <span class="keyword">break</span>;	<span class="comment">//右转</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">56</span>: Flag_Qian=<span class="number">0</span>,Flag_Hou=<span class="number">0</span>,Flag_Left=<span class="number">0</span>,Flag_Right=<span class="number">0</span>; <span class="keyword">break</span>;	<span class="comment">//停止</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">162</span>: mode_flag = <span class="number">0</span>; <span class="keyword">break</span>;	<span class="comment">//遥控模式</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">98</span>: mode_flag = <span class="number">1</span>; <span class="keyword">break</span>;	<span class="comment">//CCD循迹模式</span></span><br><span class="line">		<span class="keyword">case</span> <span class="number">226</span>: mode_flag = <span class="number">2</span>; <span class="keyword">break</span>;	<span class="comment">//超声波避障模式</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>然后补上头文件即可完成全部的代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __TIMER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __TIMER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DATA_PIN   PBin(0)		<span class="comment">//红外数据输入脚</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REMOTE_ID 0      		   </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> u8 RmtCnt;	        <span class="comment">//按键按下的次数</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Remote_Init</span><span class="params">(<span class="keyword">void</span>)</span></span>;     <span class="comment">//红外传感器接收头引脚初始化</span></span><br><span class="line"><span class="function">u8 <span class="title">Remote_Scan</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">read_yaokong</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>显然从逻辑分析仪看，我的红外遥控器发送的地址码是0x00，所以直接宏定义为0即可。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/04/%E5%B9%B3%E8%A1%A1%E8%BD%A6PID/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/04/%E5%B9%B3%E8%A1%A1%E8%BD%A6PID/" itemprop="url">平衡车PID分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-06-04T20:46:21+08:00">
                2020-06-04
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/STM32%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">STM32学习记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="初步认识PID"><a href="#初步认识PID" class="headerlink" title="初步认识PID"></a>初步认识PID</h2><p>对于我这个非控制院的学生来说，这方面的理论知识本来就不足，加上以前基本上干的都是点灯的事，没有涉及控制算法的编写，所以写PID的程序是很懵逼的，因此首先要明白究竟什么是PID。</p>
<p>首先，要明白什么情况下要用到PID控制：用户设定一个期望值，我们希望控制一个受控物体，通常是一个物理量，能够尽可能快的达到一个值，并且能够稳定住。那么这个控制器就需要一个或多个输入值，一个是用户的期望值，其他则是测量物理量的传感器的值。</p>
<p>P：proportion，比例，就是用户期望值，与传感器返回值的<strong>差值</strong>，<strong>偏差</strong>。</p>
<p>I：integral，积分，记录了从某一时刻开始，所有的<strong>偏差的累积</strong>。</p>
<p>D：derivative，微分，是偏差的偏差，相当于<strong>偏差的导数</strong>，<strong>偏差变化的速率</strong>。</p>
<p>在实际的运用中，我们不一定要用这里面的所有，但是一定是基于P的控制，积分和微分都是在数据上对偏差进行处理，可以有PI控制，可以有PD控制，也存在PID控制。</p>
<h2 id="结合平衡车，深度理解PID"><a href="#结合平衡车，深度理解PID" class="headerlink" title="结合平衡车，深度理解PID"></a>结合平衡车，深度理解PID</h2><h3 id="比例控制：把握当下"><a href="#比例控制：把握当下" class="headerlink" title="比例控制：把握当下"></a>比例控制：把握当下</h3><p>那么，究竟什么时候用PI，什么时候用PD呢？这就要从原理说起。</p>
<p>比如我做一个平衡车，希望通过一种控制算法来实现平衡，最容易想到的方法就是<strong>比例控制</strong>：</p>
<p>1、我希望平衡车稳定达到平衡状态（用户期望值）是平衡车的机械平衡角度（目标物理量），以及受控物体的角度，MPU6050传感器的DMP度数，</p>
<p>2、两个数据的<strong>偏差</strong>，<strong>作为输入</strong>控制器的值，在控制器中乘上一个<strong>增益</strong>，经过输出<strong>限幅</strong>，然后<strong>输出给执行器件</strong>：电机，</p>
<p>3、电机的工作状态，反过来又会影响平衡车的角度，角度又会被传感器收集，重新计算偏差，输入控制器。</p>
<p>于是，这样一个偏差控制器就形成了一个<strong>闭环</strong>。</p>
<p><strong>理论上</strong>，一个理想的P控制器，只能使受控物理量无限接近目标值，因为当偏差逐渐减小，趋于零时，控制器的输入趋于零，那么无论有多大增益，输出也会趋于零，这样就会停在一个固定值。</p>
<p>但是在<strong>实际中</strong>，我们要考虑多种因素，第一，输出趋于零，小车可不会静止在一个角度，而是迅速倒下，第二，实际上第一种情况也是不存在的，因为从控制器输出PWM给电机，到平衡车角度改变，本身就是有很长时间的<strong>延时</strong>，会有<strong>惯性</strong>，这种控制<strong>影响总是延后造成</strong>。因此，真正的情况是，平衡车的角度已经很接近机械零度了，电机的输出也已经快要停止了，然而，平衡车却有一个<strong>角速度</strong>，方向正是最初纠正平衡车的方向，这样，<strong>就算停掉电机，小车依然会越过平衡点</strong>，越过平衡点之后，<strong>偏差</strong>为负数，但是<strong>数值却很小</strong>，偏差经过控制器增益、限幅、输出给电机，<strong>电机却无法产生足够及时纠正偏离的转动</strong>，于是到小车反向倒下足够大的角度时，电机输出的转速才足够纠正，最终的结果就是，小车开始出现大幅度的<strong>震荡</strong>，根本无法平衡。</p>
<h3 id="比例-微分控制：预测未来，控制平衡"><a href="#比例-微分控制：预测未来，控制平衡" class="headerlink" title="比例+微分控制：预测未来，控制平衡"></a>比例+微分控制：预测未来，控制平衡</h3><p>如何改善这种震荡呢，经过前面的分析，我们知道，出现震荡的根本原因是机械系统的惯性，导致输出对受控物体的影响总是延后的。问题就出在，当角度接近机械零度时，我们的P控制器不工作了，<strong>控制器认为完成了任务，然而控制器忽略了一种对下一个时刻的预测</strong>，那么这个对下一个时刻的<strong>预测</strong>，指的就是<strong>角度偏差的导数</strong>，角度变化的速率，就是<strong>角速度</strong>。</p>
<p>有了这个认识，我们继续分析，角度偏差接近零度，但是系统<strong>存在角速度</strong>，那么<strong>下一刻就一定会有角度偏差</strong>，并且方向与角速度方向相反，通过数据，获取到角速度，就能够通过角速度，来修正这种状态，有预见性的输出给电机，让电机在下一个时刻就开始纠正偏差的倾向。</p>
<p>于是，我们加入D控制，微分项，相当于一个阻尼力：<strong>在偏差项P占主导时，微分项D的影响相对来说非常小，然而当偏差趋于零时，微分项的作用就是，减慢受控物理量的变化速率</strong>。</p>
<p>这样做的核心原理就是，<strong>既然控制存在滞后，那我就提前控制</strong>，就达到了抑制震荡，促进系统在平衡点稳定的目的。</p>
<h3 id="比例-积分控制：总结过去，控制位置"><a href="#比例-积分控制：总结过去，控制位置" class="headerlink" title="比例+积分控制：总结过去，控制位置"></a>比例+积分控制：总结过去，控制位置</h3><p>上面的PD控制系统，基本上可以让平衡小车处于一个短期稳定平衡的状态，但是肯定不能长时间平衡，原因呢，要从具体的平衡控制结构来分析。</p>
<p>我们的传感器是单一的MPU6050，通过DMP库，输出的是角度以及角速度信号，而我们控制的是电机，也就是说，我们不考虑电机的感受，只要求平衡车的角度能够保持在机械零度，那么一旦平衡车收到扰动，或者控制闭环的任何一个环节，出现了微小的干扰，平衡车就会向一个方向加速，角度还是平衡的，但是平移的速度却没有限制，这样一旦驱动电机的PWM信号达到了限幅的数值，电机不再加速旋转，小车的执行器件就失去了执行能力，就会向这个方向倒下。</p>
<p>经过分析，我们需要再参考一个<strong>物理量</strong>，就是<strong>编码器的读数</strong>，既然使用编码电机，编码器的读数就需要纳入测量范围。然后问题又来了，如何处理读到的编码器数据呢？我们设置定时器模式为AB相编码器模式，那么每次读编码器，得到的是0-65535这个区间的一个值，电机转动，编码器的读数就会变化，我们希望小车在一个位置静止，就需要在平衡PD控制的基础上，加上一个<strong>位置控制</strong>，两种信号经过处理，输入控制器，控制器经过融合，输出给电机。</p>
<p>现在的问题是，<strong>位置控制</strong>使用什么样的方法？显然，<strong>位置控制并不像角度的平衡控制，电机转动就能够较快地达到效果</strong>，因此，我们需要一段时间，一步一步地<strong>接近</strong>我们设定的位置，也就是说，需要使用<strong>速度控制</strong>，<strong>对速度的一步步累积</strong>，使小车的位置（编码器的读数）逐渐趋于某一个值，这就要用到PI算法，即<strong>比例+积分</strong>控制来实现速度控制。</p>
<p>继续分析，我们假设用户输入的目标值是放下小车时刻，编码器的读数就是小车（车轮）的速度，这里可能就有点问题了，明明编码器的读数是脉冲信号，是位置啊，为什么说是速度呢？这就涉及到对编码器的数据处理，我们每隔一段时间，我们读取CNT寄存器，然后软件清零，意味着我们每次读取的数据，都是<strong>一段时间的计数值变化</strong>，不就是<strong>速度</strong>吗。弄清楚这个，我们开始分析怎么实现比例+积分的控制。</p>
<p>每隔一定周期，我们获取一次编码器的速度，然后与用户期望的速度，得到一个偏差，这个偏差就是P（比例），很显然偏差越大，我们需要的回复力就越大。到这里，我们吧前面的平衡PD控制，加上速度P控制，经过调整三个增益的大小以及比例，在控制器中对信号进行简单的叠加（叠加式PID，另外还有串联式，这里没有用到），就能够完美的实现小车的长时间稳定了。完美的状态是，推动小车，小车会前进一段距离，然后重新进入平衡。</p>
<p>那么，我们如果想要实现小车能够<strong>记住自己的位置，在受到外部干扰后自动回复到初始位置</strong>，该如何操作呢？注意，这里我提到了<strong>记住</strong>这么一个概念，就不难想到，这种控制，<strong>需要历史的全部速度信息</strong>，对离散的速度进行<strong>积分</strong>，得到从初始时刻，到当前时刻的<strong>位置信息</strong>。为了做到这一点，我们需要引入速度PI控制，比例+积分。具体的操作就是：从开始时刻，固定周期将速度偏差进行累加（具体可能需要滤波，这里讲解原理，略去），这个累加的值，就是偏离的距离，把这个距离，经过一个增益，也叠加进前面的3个参数，一共4个参数，共同作为输入，经过控制器输出给电机，这样就实现了在一个位置的PD+PI控制算法。</p>
<h2 id="通过代码，分析PID的各个组成部分"><a href="#通过代码，分析PID的各个组成部分" class="headerlink" title="通过代码，分析PID的各个组成部分"></a>通过代码，分析PID的各个组成部分</h2><h3 id="比例-微分：直立环"><a href="#比例-微分：直立环" class="headerlink" title="比例+微分：直立环"></a>比例+微分：直立环</h3><h4 id="比例输入：期望角度与当前角度的偏差"><a href="#比例输入：期望角度与当前角度的偏差" class="headerlink" title="比例输入：期望角度与当前角度的偏差"></a>比例输入：期望角度与当前角度的偏差</h4><p>期望角度，就是我们通过提前测量，得到的平衡车直立时的6050的读数，因为传感器的安装是存在误差的，并且小车的质心投影也不一定在两轮中心连线上，因此有必要提前测量机械角度中值，作为期望角度。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ZHONGZHI -4.5						<span class="comment">//平衡机械中值，与MPU6050的安装位置有关</span></span></span><br></pre></td></tr></table></figure>
<p>然后我们通过DMP的方式，读取到小车当前的角度：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Read_DMP</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;	</span><br><span class="line">	  <span class="keyword">unsigned</span> <span class="keyword">long</span> sensor_timestamp;</span><br><span class="line">		<span class="keyword">unsigned</span> <span class="keyword">char</span> more;</span><br><span class="line">		<span class="keyword">long</span> quat[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line">				dmp_read_fifo(gyro, accel, quat, &amp;sensor_timestamp, &amp;sensors, &amp;more);		</span><br><span class="line">				<span class="keyword">if</span> (sensors &amp; INV_WXYZ_QUAT )</span><br><span class="line">				&#123;</span><br><span class="line">					q0=quat[<span class="number">0</span>] / q30;</span><br><span class="line">					q1=quat[<span class="number">1</span>] / q30;</span><br><span class="line">					q2=quat[<span class="number">2</span>] / q30;</span><br><span class="line">					q3=quat[<span class="number">3</span>] / q30;</span><br><span class="line">					Pitch = <span class="built_in">asin</span>(<span class="number">-2</span> * q1 * q3 + <span class="number">2</span> * q0* q2)* <span class="number">57.3</span>; 	</span><br><span class="line">					Roll= <span class="built_in">atan2</span>(<span class="number">2</span> * q2 * q3 + <span class="number">2</span> * q0 * q1, <span class="number">-2</span> * q1 * q1 - <span class="number">2</span> * q2* q2 + <span class="number">1</span>)* <span class="number">57.3</span>; <span class="comment">// roll</span></span><br><span class="line">				&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里，我们设定一个全局变量Roll，通过四元数算出的值就是小车的滚转角，与中值做差，就是角度的偏差：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Read_DMP();					  	<span class="comment">//===读取加速度、角速度、倾角</span></span><br><span class="line">Angle_Balance=-Roll;			<span class="comment">//===更新平衡倾角</span></span><br><span class="line">Bias=Angle-ZHONGZHI;			<span class="comment">//===求出平衡的角度偏差</span></span><br></pre></td></tr></table></figure>
<h4 id="微分输入：两个周期得到的角度偏差的差值"><a href="#微分输入：两个周期得到的角度偏差的差值" class="headerlink" title="微分输入：两个周期得到的角度偏差的差值"></a>微分输入：两个周期得到的角度偏差的差值</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Gyro_Balance=-gyro[<span class="number">0</span>];			<span class="comment">//===更新滚转角速度</span></span><br></pre></td></tr></table></figure>
<p>这里的gyro是一个DMP库自带的一个数组，存储了xyz三个轴的角速度AD值，传感器能读出角速度，我们就不需要再去自己计算微分了。</p>
<h4 id="融合：比例-微分信号"><a href="#融合：比例-微分信号" class="headerlink" title="融合：比例+微分信号"></a>融合：比例+微分信号</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">balance=Balance_Kp*Bias+Balance_Kd*Gyro;</span><br></pre></td></tr></table></figure>
<p>这样就得到了<strong>直立PD控制</strong>所需的PWM信号，当然，现在还没有输出，因为后面需要融合速度PI控制，之后再进行输出。</p>
<h3 id="比例-积分：速度环"><a href="#比例-积分：速度环" class="headerlink" title="比例+积分：速度环"></a>比例+积分：速度环</h3><h4 id="比例输入：期望速度与当前速度的偏差"><a href="#比例输入：期望速度与当前速度的偏差" class="headerlink" title="比例输入：期望速度与当前速度的偏差"></a>比例输入：期望速度与当前速度的偏差</h4><p>这里先介绍最简单的，期望速度为0。我们配置定时器为编码器模式，不分频，向上计数，0-65535，CH1+CH2四倍频。这样，CNT计数寄存器中的值，就记录的小车的位置，我们每隔10ms读取一次寄存器的值，然后清零，具体的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">Read_Encoder</span><span class="params">(u8 TIMX)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">int</span> Encoder_TIM;	</span><br><span class="line">	<span class="keyword">switch</span>(TIMX)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">case</span> <span class="number">2</span>:  Encoder_TIM= (short)TIM2 -&gt; CNT;  TIM2 -&gt; CNT=<span class="number">0</span>;<span class="keyword">break</span>;	</span><br><span class="line">		<span class="keyword">case</span> <span class="number">4</span>:  Encoder_TIM= (short)TIM4 -&gt; CNT;  TIM4 -&gt; CNT=<span class="number">0</span>;<span class="keyword">break</span>;	</span><br><span class="line">		<span class="keyword">default</span>:  Encoder_TIM=<span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> Encoder_TIM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>这里一定要注意，并且理解这个强制类型转换的作用：</strong></p>
<p>我们设定编码器模式，向上计数，那么电机正转，T计数器从0增加，增加到65535时，就会归零，再增加，这样循环。那么一旦反转，就会从0递减到65535，这样的速度偏差就是65535，这显然不是我们想看到的。但是从底层原理解释，本来读寄存器，都是我们经过<strong>强转类型</strong>，把寄存器赋值给一个我们规定类型的变量。那这里我们<strong>把这个变量转成有符号</strong>的不就有了正负？于是，墙砖城short类型，这个计数的范围就变成了-23768到+23767循环计数，这样，偏差就有了正负之分。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Encoder_Left	=	Read_Encoder(<span class="number">2</span>);		<span class="comment">//===读取编码器1的值</span></span><br><span class="line">Encoder_Right	=	Read_Encoder(<span class="number">4</span>);		<span class="comment">//===读取编码器2的值</span></span><br></pre></td></tr></table></figure>
<p>由于是周期性读取编码器，那么这个读取的值，就是小车的当前速度。</p>
<h4 id="积分输入：两个周期得到的比例的累积"><a href="#积分输入：两个周期得到的比例的累积" class="headerlink" title="积分输入：两个周期得到的比例的累积"></a>积分输入：两个周期得到的比例的累积</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">float</span> Velocity,Encoder_Least,Encoder,Movement;</span><br></pre></td></tr></table></figure>
<p>这里定义了几个<strong>static变量</strong>，可以保存上一次的变化值，是<strong>积分实现的编程基础</strong>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Encoder_Least =(encoder_left+encoder_right)<span class="number">-0</span>;</span><br></pre></td></tr></table></figure>
<p>这一句，左轮速度加右轮速度，就得到了小车的几何中心的速度，可以代表小车的速度。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Encoder *= <span class="number">0.7</span>;    </span><br><span class="line">Encoder += Encoder_Least*<span class="number">0.3</span>;</span><br></pre></td></tr></table></figure>
<p>这是一个简单的<strong>低通滤波器</strong>，作用是减缓速度的变化。因为我们只是将速度环和直立环做了一个<strong>简单的线性叠加</strong>，而直立是一切的基础，我们<strong>不希望速度环对直立环造成过大的干扰</strong>，所以在这里需要做一个滤波的处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Encoder_Integral += Encoder;</span><br></pre></td></tr></table></figure>
<p>这一步，就做了一个积分的操作，每执行一次，这个变量都会累加之前的速度偏差，得到速度的积分：位移。</p>
<h4 id="融合：比例-积分信号"><a href="#融合：比例-积分信号" class="headerlink" title="融合：比例+积分信号"></a>融合：比例+积分信号</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Velocity=Encoder*Velocity_Kp+Encoder_Integral*Velocity_Ki;</span><br></pre></td></tr></table></figure>
<p>这样就得到了<strong>速度PI控制</strong>所需的电机PWM信号，下一步就是融合两个闭环控制。</p>
<h3 id="最终融合：直立PD-速度PI"><a href="#最终融合：直立PD-速度PI" class="headerlink" title="最终融合：直立PD+速度PI"></a>最终融合：直立PD+速度PI</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Balance_Pwm		=	Get_balance_PWM(Angle_Balance,Gyro_Balance);	<span class="comment">//===平衡PD控制	</span></span><br><span class="line">Velocity_Pwm	=	Get_velocity_PWM(Encoder_Left,Encoder_Right);	<span class="comment">//===速度环PI控制</span></span><br><span class="line">Moto1			=	Balance_Pwm - Velocity_Pwm;						<span class="comment">//===计算左轮电机最终PWM</span></span><br><span class="line">Moto2			=	Balance_Pwm - Velocity_Pwm;						<span class="comment">//===计算右轮电机最终PWM</span></span><br><span class="line">Xianfu_Pwm();						<span class="comment">//===PWM限幅</span></span><br><span class="line">Set_Pwm(Moto1,Moto2);				<span class="comment">//===赋值给PWM寄存器</span></span><br></pre></td></tr></table></figure>
<p>这一步，就实现了控制器的信号输出，设定驱动电机工作的PWM信号，调节Kp(balance)，Kd(balance)，Kp(velocity)，Ki(velocity)，四个参数，就可以实现小车平衡在某一个位置了。</p>
<h2 id="总结：PID总体框图"><a href="#总结：PID总体框图" class="headerlink" title="总结：PID总体框图"></a>总结：PID总体框图</h2><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200605214510254.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="小车平衡PID框图"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/20/%E7%94%B5%E6%9C%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/20/%E7%94%B5%E6%9C%BA/" itemprop="url">减速直流有刷电机</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-20T19:45:11+08:00">
                2020-05-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/STM32%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">STM32学习记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="电机的基本认识"><a href="#电机的基本认识" class="headerlink" title="电机的基本认识"></a>电机的基本认识</h2><p>这里呢，平衡小车最常用到的是<strong>直流编码有刷电机</strong>，<strong>直流</strong>的意思是使用直流电，给引脚通的是恒定电流；<strong>编码</strong>指的是电机自带编码盘，上面有两个相位正交的编码器，可以利用四倍频技术实现对电机位置和转速的精确追踪；<strong>有刷</strong>指的是电机内部自带换向器，电机转子每旋转180度，线圈中的电流即自动换向，不需要软件或者硬件驱动的控制。</p>
<p>这种电机通常有6个引脚：电源引脚：5V、GND，PWM输入引脚：IN1、IN2，编码器输出引脚：OUT1、OUT2。</p>
<p>PCB走线时要注意只有编码器引脚是信号线，可以走细一些，其他线建议走粗一些（30mil以上）。</p>
<h2 id="电机驱动：TB6612"><a href="#电机驱动：TB6612" class="headerlink" title="电机驱动：TB6612"></a>电机驱动：TB6612</h2><p>由于STM32的引脚只能提供3.3V电压，且功率输出能力很弱，因此需要功率放大器件对电机进行控制，并且为了保持控制的实时性，以及精准性，需要高速的功率控制器件，这就需要一款专用的电机驱动芯片。</p>
<p>这里使用体积较小，同时有较大驱动能力的TB6612驱动芯片，可以同时驱动两路电机，利用其内部的高速H桥，向电机输出PWM波，控制其正传，反转，制动，自由转动（不加动力也不加阻尼力），以及转速的调节。</p>
<p>驱动芯片除了电源引脚以及使能引脚之外，还有各两组，两种功能的引脚：</p>
<ul>
<li><p>来自MCU的3个引脚：1个PWM输入引脚，用于控制转速，2个控制引脚，用于控制正反，制动，空挡（不施加力）。</p>
</li>
<li><p>输出给电机的2个引脚：OUT1，OUT2，通过输出PWM波控制电机的全部功能，搭载较大电流。</p>
</li>
</ul>
<h2 id="驱动编写"><a href="#驱动编写" class="headerlink" title="驱动编写"></a>驱动编写</h2><p>通过对电机以及电机驱动的功能分析，我们知道了控制<strong>1个电机</strong>，需要<strong>3个引脚</strong>，1个<strong>输出PWM波</strong>用于控制速度，2个<strong>高速推挽输出</strong>，通过切换高低电平，即可实现对电机的驱动状态控制。</p>
<p>平衡车有2个电机需要控制，因此用于驱动电机的引脚有6个，2个是定时器的PWM功能映射的引脚。</p>
<p>这里我为了节省定时器资源，使用一个定时器TIM1，该定时器的1、4通道（分别对应PA8，PA11引脚），来输出两路频率相同，但是占空比互不影响，独立可调的PWM信号，然后另外找4个普通IO口，用于对电机状态进行控制。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200522171503509.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="TIM1映射"></p>
<h3 id="电机驱动"><a href="#电机驱动" class="headerlink" title="电机驱动"></a>电机驱动</h3><h4 id="MOTOR-h"><a href="#MOTOR-h" class="headerlink" title="MOTOR.h"></a>MOTOR.h</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __MOTOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MOTOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys.h&gt;			//包含引脚转换的宏函数，便于编写代码</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PWMA   TIM1-&gt;CCR1  <span class="comment">//用于控制A电机的PWM占空比调节</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIN2   PBout(15)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIN1   PBout(14)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PWMB   TIM1-&gt;CCR4  <span class="comment">//用于控制B电机的PWM占空比调节</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIN1   PBout(13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIN2   PBout(12)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MiniBalance_PWM_Init</span><span class="params">(u16 arr,u16 psc)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MiniBalance_Motor_Init</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这里干了几件事：</p>
<ul>
<li><p>电机控制引脚宏定义</p>
</li>
<li><p>PWM占空比改变宏定义</p>
</li>
<li>两个初始化函数宏定义</li>
</ul>
<h4 id="MOTOR-c"><a href="#MOTOR-c" class="headerlink" title="MOTOR.c"></a>MOTOR.c</h4><p>首先是对4个控制引脚的初始化，高速下拉推挽输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MOTOR.h"</span></span></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef 	TIM1_Handler = &#123;<span class="number">0</span>&#125;;	  	<span class="comment">//定时器1句柄 </span></span><br><span class="line">TIM_OC_InitTypeDef 	TIM1_CH14Handler = &#123;<span class="number">0</span>&#125;;	<span class="comment">//定时器1通道14句柄</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MiniBalance_Motor_Init</span><span class="params">(<span class="keyword">void</span>)</span>		<span class="comment">//完成4个控制引脚的初始化</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_Initure = &#123;<span class="number">0</span>&#125;;	<span class="comment">//声明初始化结构体</span></span><br><span class="line">	__HAL_RCC_GPIOB_CLK_ENABLE();			<span class="comment">//开启GPIOB时钟</span></span><br><span class="line"></span><br><span class="line">	GPIO_Initure.Pin = GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15;	<span class="comment">//端口配置</span></span><br><span class="line">	GPIO_Initure.Pull = GPIO_NOPULL;</span><br><span class="line">	GPIO_Initure.Mode = GPIO_MODE_OUTPUT_PP;	  						<span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_Initure.Speed = GPIO_SPEED_FREQ_HIGH;					 <span class="comment">//50M</span></span><br><span class="line">	</span><br><span class="line">	HAL_GPIO_Init(GPIOB, &amp;GPIO_Initure);				  <span class="comment">//根据设定参数初始化GPIOB </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是对PWM外设的<strong>初始化</strong>，这里<strong>用定时器1的1、4通道</strong>，映射到PA8和PA11两个引脚用来控制两个电机的转速：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TIM1 PWM初始化 </span></span><br><span class="line"><span class="comment">//arr：自动重装值。</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="comment">//定时器溢出时间计算方法:Tout=((arr+1)*(psc+1))/Ft us.</span></span><br><span class="line"><span class="comment">//Ft=定时器工作频率,单位:Mhz</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MiniBalance_PWM_Init</span><span class="params">(u16 arr,u16 psc)</span>		<span class="comment">//完成两个PWM输出引脚的初始化</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TIM1_Handler.Instance=TIM1;							<span class="comment">//定时器1</span></span><br><span class="line">	TIM1_Handler.Init.Prescaler=psc;					<span class="comment">//定时器分频</span></span><br><span class="line">	TIM1_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;	<span class="comment">//向上计数模式</span></span><br><span class="line">	TIM1_Handler.Init.Period=arr;		 				<span class="comment">//自动重装载值</span></span><br><span class="line">	TIM1_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;</span><br><span class="line">	HAL_TIM_PWM_Init(&amp;TIM1_Handler);	  			 <span class="comment">//初始化PWM</span></span><br><span class="line">	</span><br><span class="line">	TIM1_CH14Handler.OCMode=TIM_OCMODE_PWM1;		 	<span class="comment">//模式选择PWM1</span></span><br><span class="line">	TIM1_CH14Handler.Pulse= <span class="number">0</span>;						<span class="comment">//设置比较值,初始占空比设为0</span></span><br><span class="line">	TIM1_CH14Handler.OCPolarity=TIM_OCPOLARITY_HIGH; 	<span class="comment">//输出极性 高电平有效 </span></span><br><span class="line">	HAL_TIM_PWM_ConfigChannel(&amp;TIM1_Handler,&amp;TIM1_CH14Handler,TIM_CHANNEL_1);<span class="comment">//初始化TIM1，PWM通道1、4</span></span><br><span class="line">	HAL_TIM_PWM_ConfigChannel(&amp;TIM1_Handler,&amp;TIM1_CH14Handler,TIM_CHANNEL_4);<span class="comment">//初始化TIM1，PWM通道1、4</span></span><br><span class="line">	</span><br><span class="line">	HAL_TIM_PWM_Start(&amp;TIM1_Handler,TIM_CHANNEL_1);	<span class="comment">//开启PWM通道1、4</span></span><br><span class="line">	HAL_TIM_PWM_Start(&amp;TIM1_Handler,TIM_CHANNEL_4);	<span class="comment">//开启PWM通道1、4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在HAL_TIM_PWM_Init()中会调用端口初始化<strong>MSP函数</strong>，需要用户重定义覆盖HAL库的若定义函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定时器底层驱动，时钟使能，引脚配置</span></span><br><span class="line"><span class="comment">//此函数会被HAL_TIM_PWM_Init()调用</span></span><br><span class="line"><span class="comment">//htim:定时器句柄</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PWM_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span>(htim-&gt;Instance==TIM1)</span><br><span class="line">	&#123;</span><br><span class="line">		__HAL_RCC_TIM1_CLK_ENABLE();			<span class="comment">//使能TIM1时钟</span></span><br><span class="line">		__HAL_AFIO_REMAP_TIM1_PARTIAL();		<span class="comment">//TIM1通道引脚部分重映射使能</span></span><br><span class="line">		__HAL_RCC_GPIOA_CLK_ENABLE();			<span class="comment">//开启GPIOA时钟</span></span><br><span class="line">		</span><br><span class="line">		GPIO_Initure.Pin=GPIO_PIN_8|GPIO_PIN_11;           	<span class="comment">//PA8 PA11</span></span><br><span class="line">		GPIO_Initure.Mode=GPIO_MODE_AF_PP;  	<span class="comment">//复用推挽输出,用于输出PWM</span></span><br><span class="line">		GPIO_Initure.Pull=GPIO_PULLDOWN;          <span class="comment">//下拉</span></span><br><span class="line">		GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;<span class="comment">//高速</span></span><br><span class="line">		HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure); 	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是中断服务函数，等等，我们设置了自动重装填，不需要中断控制，OK结束。</p>
<h2 id="如何使用电机：实践"><a href="#如何使用电机：实践" class="headerlink" title="如何使用电机：实践"></a>如何使用电机：实践</h2><h3 id="控制集成封装"><a href="#控制集成封装" class="headerlink" title="控制集成封装"></a>控制集成封装</h3><p>这里集成了控制小车所需的代码，现在只添加电机控制这一模块</p>
<h4 id="CONTROL-h"><a href="#CONTROL-h" class="headerlink" title="CONTROL.h"></a>CONTROL.h</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __CONTROL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __CONTROL_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Set_Pwm</span><span class="params">(<span class="keyword">int</span> moto1,<span class="keyword">int</span> moto2)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">myabs</span><span class="params">(<span class="keyword">int</span> a)</span></span>;					<span class="comment">//绝对值函数</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>两个函数，核心是第一个，设置PWM的重装填阈值，相当于控制了占空比，这样就实现了调速的功能。</p>
<h4 id="CONTROL-c"><a href="#CONTROL-c" class="headerlink" title="CONTROL.c"></a>CONTROL.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"CONTROL.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************************</span></span><br><span class="line"><span class="comment">函数功能：赋值给PWM寄存器</span></span><br><span class="line"><span class="comment">入口参数：左轮PWM、右轮PWM</span></span><br><span class="line"><span class="comment">返回  值：无</span></span><br><span class="line"><span class="comment">**************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Set_Pwm</span><span class="params">(<span class="keyword">int</span> moto1,<span class="keyword">int</span> moto2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="keyword">int</span> siqu=<span class="number">500</span>;<span class="comment">//死区补偿,防止数值过小无法驱动</span></span><br><span class="line">			<span class="keyword">if</span>(moto1&lt;<span class="number">0</span>)			BIN2=<span class="number">0</span>,			BIN1=<span class="number">1</span>;		<span class="comment">//正转</span></span><br><span class="line">			<span class="keyword">else</span> 	          BIN2=<span class="number">1</span>,			BIN1=<span class="number">0</span>;		<span class="comment">//反转</span></span><br><span class="line">			PWMB=myabs(moto1)+siqu;</span><br><span class="line">		  <span class="keyword">if</span>(moto2&lt;<span class="number">0</span>)	AIN1=<span class="number">0</span>,			AIN2=<span class="number">1</span>;				<span class="comment">//正转</span></span><br><span class="line">			<span class="keyword">else</span>        AIN1=<span class="number">1</span>,			AIN2=<span class="number">0</span>;				<span class="comment">//反转</span></span><br><span class="line">			PWMA=myabs(moto2)+siqu;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**************************************************************************</span></span><br><span class="line"><span class="comment">函数功能：绝对值函数</span></span><br><span class="line"><span class="comment">入口参数：int</span></span><br><span class="line"><span class="comment">返回  值：unsigned int</span></span><br><span class="line"><span class="comment">**************************************************************************/</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">myabs</span><span class="params">(<span class="keyword">int</span> a)</span></span></span><br><span class="line"><span class="function"></span>&#123; 		   </span><br><span class="line">	  <span class="keyword">int</span> temp;</span><br><span class="line">		<span class="keyword">if</span>(a&lt;<span class="number">0</span>)  temp=-a;  </span><br><span class="line">	  <span class="keyword">else</span> temp=a;</span><br><span class="line">	  <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面这个是实现功能的函数，Set_pwm函数是根据TB6612电机驱动芯片的真值表来计算的，通过直接访问TIM1的CCR寄存器，注意考虑两个电机的中心对称分布，所以写的时候将一个反向，实现输入两个正数，两个电机的转动都使小车向前走即可。</p>
<h3 id="mian函数："><a href="#mian函数：" class="headerlink" title="mian函数："></a>mian函数：</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//头文件略去</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HAL_Init();</span><br><span class="line">	Stm32_Clock_Init(RCC_CFGR_PLLMULL9);</span><br><span class="line">	JTAG_Set(SWD_ENABLE);</span><br><span class="line">	<span class="comment">//uart_init(115200);</span></span><br><span class="line">	delay_init(<span class="number">72</span>);</span><br><span class="line">	KEY_Init();</span><br><span class="line">	MiniBalance_Motor_Init();</span><br><span class="line">	MiniBalance_PWM_Init(<span class="number">7199</span>,<span class="number">0</span>);   <span class="comment">//PWM输出，溢出值7200，不分频，10KHz频率，100um周期</span></span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		Set_Pwm(<span class="number">3000</span>, <span class="number">3000</span>);</span><br><span class="line">		delay_ms(<span class="number">1000</span>);</span><br><span class="line">		Set_Pwm(<span class="number">-3000</span>, <span class="number">-3000</span>);</span><br><span class="line">		delay_ms(<span class="number">1000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里放了一个最简单的一秒正转，一秒反转，因为还没有研究PID的原理，后面会结合MPU6050触发中断来进行数据处理，反馈给电机，来进行最基本的控制。网上找不到HAL库的历程，就搞来FW3.5标准库来研究，慢慢摸索终于把这电机弄转起来了，实现了多轮运动嘿嘿。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/20/%E5%AE%9A%E6%97%B6%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/20/%E5%AE%9A%E6%97%B6%E5%99%A8/" itemprop="url">STM32——外设Timer定时器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-20T14:43:52+08:00">
                2020-05-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/STM32%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">STM32学习记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="对定时器的基本认识"><a href="#对定时器的基本认识" class="headerlink" title="对定时器的基本认识"></a>对定时器的基本认识</h2><p>先来看看这种MCU有多少定时器：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200508202457610.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="STM32定时器分类"></p>
<p>定时器分为3类：</p>
<ol>
<li><strong>基本定时器</strong>的功能最少，只能充当基本的时基，甚至都没有外部引脚。</li>
<li><strong>通用定时器</strong>拥有基本定时器的全部功能，同时有输入捕获模式，用以接收外部的PWM，脉冲之类的信息，也有</li>
<li><strong>高级定时器</strong>又有通用定时器的全部功能，又有互补输出模式，功能最为强大</li>
</ol>
<p>先具体看一下夹在中间的通用定时器的官方文档中的描述：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200508202457535.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt=""></p>
<p>为什么需要定时器，并且需要这么多定时器呢？这是因为STM32的处理器是一种单线程的模式，这这时如果没有一个专门的外设，那么在软件定时期间就无法处理其他的工作。于是ST就提供了这些可以独立工作的定时器来完成需要的定时工作。</p>
<p><strong>定时器的心脏：时基</strong></p>
<p>1、内部时钟（CK_INT）</p>
<p>2、外部时钟模式 1：外部输入脚（TIx） </p>
<p>3、外部时钟模式 2：外部触发输入（ETR） </p>
<p>4、内部触发输入（ITRx）：使用 A 定时器作为 B 定时器的预分频器（A 为 B 提供时钟）。 这些时钟，具体选择哪个可以通过 TIMx_SMCR 寄存器的相关位来设置。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200508202457117.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="定时器时基"></p>
<p>在这里呢，最基本的定时功能就是功能1，如上图，基本定时器和通用定时器是挂载在<strong>APB1低速总线</strong>的，和PCLK<strong>共用</strong>来自APB1预分频器的时钟源，这个总线的最大频率是36M，但是由于预分频器分频倍数是1，所以在这里就由系统自动给<strong>双倍频率</strong>了，因此基本定时器和通用定时器的时钟频率都是<strong>72MHz</strong>的。</p>
<h2 id="实践1：定时器溢出中断"><a href="#实践1：定时器溢出中断" class="headerlink" title="实践1：定时器溢出中断"></a>实践1：定时器溢出中断</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>这个功能就和传统8051单片机的定时器功能一样，计数，溢出，触发中断，简单明了，多了个自动重装载功能，应该是最简单的定时器功能了，甚至基本定时器都能够完成，我就从这里开始学习定时器吧。</p>
<p>和GPIO，串口，外部中断一样，创建并添加src文件和inc文件：</p>
<h3 id="TIMER-h"><a href="#TIMER-h" class="headerlink" title="TIMER.h"></a>TIMER.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _TIMER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _TIMER_H</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> TIM_HandleTypeDef TIM3_Handler;      <span class="comment">//定时器句柄</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_Init</span><span class="params">(u16 arr,u16 psc)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="TIMER-c"><a href="#TIMER-c" class="headerlink" title="TIMER.c"></a>TIMER.c</h3><p>首先是初始化程序，一切是那么熟悉，从GPIO起，我们都使用HAL库提供的初始化结构体来初始化外设。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"TIMER.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"LED.h"</span></span></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef TIM3_Handler;      <span class="comment">//定时器句柄 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器溢出时间计算方法:Tout=((arr+1)*(psc+1))/Ft us.</span></span><br><span class="line"><span class="comment">//Ft=定时器工作频率,单位:Mhz</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_Init</span><span class="params">(<span class="keyword">uint16_t</span> arr,<span class="keyword">uint16_t</span> psc)</span>		<span class="comment">//arr：自动重装值	psc：时钟预分频数</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    TIM3_Handler.Instance=TIM3;                          <span class="comment">//通用定时器3</span></span><br><span class="line">    TIM3_Handler.Init.Prescaler=psc;                     <span class="comment">//分频系数</span></span><br><span class="line">    TIM3_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;    <span class="comment">//向上计数器</span></span><br><span class="line">    TIM3_Handler.Init.Period=arr;                        <span class="comment">//自动装载值</span></span><br><span class="line">    TIM3_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;<span class="comment">//时钟分频因子</span></span><br><span class="line">    HAL_TIM_Base_Init(&amp;TIM3_Handler);			<span class="comment">//时基初始化</span></span><br><span class="line">    </span><br><span class="line">    HAL_TIM_Base_Start_IT(&amp;TIM3_Handler); <span class="comment">//使能定时器3和定时器3更新中断：TIM_IT_UPDATE   </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>追究底层原理的话，这些给结构体成员赋值的过程中，主要就是在操作CR1，CR2控制寄存器，完成定时器最基本的设置基础计时频率的过程，经过初始化函数上，就完成了这些配置。</p>
<p>CounterMode：TIM_COUNTERMODE_UP        TIM_COUNTERMODE_DOWN下</p>
<p> Channel：用来设置活跃通道。每个定时器最多有四个通道可 以用来做输出比较，输入捕获等功能之用。这里的 Channel 就是用来设置活跃通道的，取值范 围为：HAL_TIM_ACTIVE_CHANNEL_1~ HAL_TIM_ACTIVE_CHANNEL_4。</p>
<p>这里呢，和串口类似，在时基初始化函数中，会调用一个__WEAK弱定义过的空函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_Base_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(htim-&gt;Instance==TIM3)</span><br><span class="line">	&#123;</span><br><span class="line">		__HAL_RCC_TIM3_CLK_ENABLE();            <span class="comment">//使能TIM3时钟</span></span><br><span class="line">		HAL_NVIC_SetPriority(TIM3_IRQn,<span class="number">1</span>,<span class="number">3</span>);    <span class="comment">//设置中断优先级，抢占优先级1，子优先级3</span></span><br><span class="line">		HAL_NVIC_EnableIRQ(TIM3_IRQn);          <span class="comment">//开启ITM3中断   </span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，初始化才正式完成，然后是中断向量表中的中断服务函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HAL_TIM_IRQHandler(&amp;TIM3_Handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又是熟悉的感觉，直接调用HAL库的处理函数，我们按照惯例，进去看看：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200508214113318.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="HAL库定时器中断处理函数"></p>
<p>这个函数居然有300多行，不过还好，机智的我把它折叠起来了，如果忽略具体实现细节，这个其实很清晰了，这个函数的作用是，通过判断定时器的寄存器，判断触发中断的到底是什么事件，是捕获比较1234，还是定时器更新事件，还是输入捕获事件，然后调用相应的回调函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(htim==(&amp;TIM3_Handler))</span><br><span class="line">    &#123;</span><br><span class="line">		HAL_GPIO_TogglePin(LED0_PORT, LED0_PIN);</span><br><span class="line">		HAL_GPIO_TogglePin(LED1_PORT, LED1_PIN);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在这里我写的是一个闪灯程序(我在前面包含了LED.h头文件)</p>
<p>在主程序中初始化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"main.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stm32f1xx.h"</span>		<span class="comment">//芯片选型的功能，里面包含了stm32f1xx_hal.c</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"LED.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"TIMER.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HAL_Init();</span><br><span class="line">	SystemClock_Config();</span><br><span class="line">	LED_Init();</span><br><span class="line">	TIM3_Init(<span class="number">9999</span>, <span class="number">7199</span>);</span><br><span class="line">	<span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到初始化的两个重要参数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_Init</span><span class="params">(<span class="keyword">uint16_t</span> arr,<span class="keyword">uint16_t</span> psc)</span>		<span class="comment">//arr：自动重装值	psc：时钟预分频数</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li><strong>自动重载值</strong>：指的是计数多少次自动重装，16位寄存器储存这个值，范围是0 - 65535，这个是向上计数，就是0到arr就会触发重装中断事件</li>
<li><strong>时钟预分频数</strong>：指的是相对于时钟基础频率(这里是72MHz)，的分频数，这个也很强大，也是16位寄存器储存这个值，范围仍然是0 - 65535。</li>
</ul>
<p>专门有2个寄存器：<strong>自动重载寄存器 预分频寄存器</strong>，看看官方的公式：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200508221302780.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="自动重载寄存器 预分频寄存器"></p>
<p>f_CK_PSC就是时钟频率，这里是2倍频后的APB1时钟，72MHz。</p>
<p>再来看看这个初始化函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TIM3_Init(<span class="number">9999</span>, <span class="number">7199</span>);</span><br></pre></td></tr></table></figure>
<p>72e-6 / (7199+1) = 1e-4 (s)    就是0.1ms的计数间隔。计数范围是0 - 9999,一共1e4一万个计数次数，相当于1s一次，触发中断，自动装填，重新运行。</p>
<h2 id="实践2：定时器输出PWM波"><a href="#实践2：定时器输出PWM波" class="headerlink" title="实践2：定时器输出PWM波"></a>实践2：定时器输出PWM波</h2><h3 id="原理-1"><a href="#原理-1" class="headerlink" title="　原理"></a>　原理</h3><p>先来看看原理，怎么输出占空比不同的，稳定频率的PWM波(节选自正点原子)：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200508222247291.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="PWM比较示意图"></p>
<p>假定定时器工作在<strong>向上计数</strong> PWM 模式，且当 CNT=CCRx 时输出 1。那么就可以得到如上的 PWM 示意图：当 CNT 值<strong>小于</strong> CCRx 的时候，IO 输出<strong>低电平</strong>(0)，当 CNT 值<strong>大于等于</strong> CCRx 的时候， IO 输出<strong>高电平</strong>(1)，当 CNT <strong>达到 ARR 值</strong>的时候，重新<strong>归零</strong>，然后<strong>重新</strong>向上<strong>计数</strong>，依次<strong>循环</strong>。 改变 CCRx 的值，就可以改变 PWM 输出的<strong>占空比</strong>，改变 ARR 的值，就可以改变 PWM 输出的<strong>频率</strong>，这就是 PWM 输出的原理。</p>
<p>前面也看到了，只有基本定时器是没有外部引脚的，不能作为输出，其他的定时器都可以输出PWM波，这里以通用定时器作为工具，操作单片机输出PWM波。</p>
<p>除了实践1中用到的寄存器，还有3种和捕获/比较有关的寄存器：2个配置用的<strong>模式寄存器</strong>TIMx_CCMR1/2</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/2020050822430159.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="TIMx_CCMR1/2"></p>
<p>4个工作时用的<strong>状态寄存器</strong>TIMx_CCR1/2/3/4，其实这里只用到一个，因为<strong>通用定时器有4个通道</strong>，一个通道对应一个这种寄存器，列出来一个看看</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200508224300828.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="TIMx_CCER"></p>
<p>1个使<strong>能寄存器</strong>TIMx_CCER</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200508224300977.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="TIMx_CCR1/2/3/4"></p>
<p>可以看到每两位控制一个通道，然后隔一个没用的保留位。</p>
<p>然后前面我们了解到除了基本定时器，其他的定时器都是有对应引脚的，这就是重映射复用功能：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200509132809728.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="TIM3复用功能重映射"></p>
<h3 id="PWM-h"><a href="#PWM-h" class="headerlink" title="PWM.h"></a>PWM.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __PWM_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __PWM_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stm32f1xx.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stm32f1xx_hal.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> TIM_HandleTypeDef TIM3_Handler;      <span class="comment">//定时器句柄 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_PWM_Init</span><span class="params">(<span class="keyword">uint16_t</span> arr,<span class="keyword">uint16_t</span> psc)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM_SetTIM3Compare2</span><span class="params">(<span class="keyword">uint32_t</span> compare)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="PWM-c"><a href="#PWM-c" class="headerlink" title="PWM.c"></a>PWM.c</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"PWM.h"</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"LED.h"</span></span></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef 	TIM3_Handler;	  	<span class="comment">//定时器句柄 </span></span><br><span class="line">TIM_OC_InitTypeDef 	TIM3_CH2Handler;	<span class="comment">//定时器3通道2句柄</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_PWM_Init</span><span class="params">(<span class="keyword">uint16_t</span> arr,<span class="keyword">uint16_t</span> psc)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	TIM3_Handler.Instance=TIM3;							<span class="comment">//定时器3</span></span><br><span class="line">	TIM3_Handler.Init.Prescaler=psc;					<span class="comment">//定时器分频</span></span><br><span class="line">	TIM3_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;	<span class="comment">//向上计数模式</span></span><br><span class="line">	TIM3_Handler.Init.Period=arr;		  				<span class="comment">//自动重装载值</span></span><br><span class="line">	TIM3_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;</span><br><span class="line">	</span><br><span class="line">	HAL_TIM_PWM_Init(&amp;TIM3_Handler);					<span class="comment">//初始化PWM</span></span><br><span class="line">	</span><br><span class="line">	TIM3_CH2Handler.OCMode=TIM_OCMODE_PWM1;				<span class="comment">//模式选择PWM1</span></span><br><span class="line">	TIM3_CH2Handler.Pulse=arr/<span class="number">100</span>;						<span class="comment">//设置比较值,此值用来确定占空比，默认比较值为自动重装载值的一半,即占空比为50%</span></span><br><span class="line">	TIM3_CH2Handler.OCPolarity=TIM_OCPOLARITY_LOW;		<span class="comment">//输出比较极性为低</span></span><br><span class="line">	</span><br><span class="line">	HAL_TIM_PWM_ConfigChannel(&amp;TIM3_Handler,&amp;TIM3_CH2Handler,TIM_CHANNEL_2);	<span class="comment">//配置TIM3通道2</span></span><br><span class="line">	</span><br><span class="line">	HAL_TIM_PWM_Start(&amp;TIM3_Handler,TIM_CHANNEL_2);		<span class="comment">//开启PWM通道2</span></span><br><span class="line">	 	   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="实践3：PWM输出用于驱动直流有刷减速电机"><a href="#实践3：PWM输出用于驱动直流有刷减速电机" class="headerlink" title="实践3：PWM输出用于驱动直流有刷减速电机"></a>实践3：PWM输出用于驱动直流有刷减速电机</h2><p>这一篇属于PWM的应用方面：节选自我的另一篇博客</p>
<h3 id="MOTOR-h"><a href="#MOTOR-h" class="headerlink" title="MOTOR.h"></a>MOTOR.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __MOTOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __MOTOR_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys.h&gt;			//包含引脚转换的宏函数，便于编写代码</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PWMA   TIM1-&gt;CCR1  <span class="comment">//用于控制A电机的PWM占空比调节</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIN2   PBout(15)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> AIN1   PBout(14)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PWMB   TIM1-&gt;CCR4  <span class="comment">//用于控制B电机的PWM占空比调节</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIN1   PBout(13)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BIN2   PBout(12)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MiniBalance_PWM_Init</span><span class="params">(u16 arr,u16 psc)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MiniBalance_Motor_Init</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这里干了几件事：</p>
<ul>
<li><p>电机控制引脚宏定义</p>
</li>
<li><p>PWM占空比改变宏定义</p>
</li>
<li>两个初始化函数宏定义</li>
</ul>
<h3 id="MOTOR-c"><a href="#MOTOR-c" class="headerlink" title="MOTOR.c"></a>MOTOR.c</h3><p>首先是对4个控制引脚的初始化，高速下拉推挽输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"MOTOR.h"</span></span></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef 	TIM1_Handler = &#123;<span class="number">0</span>&#125;;	  	<span class="comment">//定时器1句柄 </span></span><br><span class="line">TIM_OC_InitTypeDef 	TIM1_CH14Handler = &#123;<span class="number">0</span>&#125;;	<span class="comment">//定时器1通道14句柄</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MiniBalance_Motor_Init</span><span class="params">(<span class="keyword">void</span>)</span>		<span class="comment">//完成4个控制引脚的初始化</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_Initure = &#123;<span class="number">0</span>&#125;;	<span class="comment">//声明初始化结构体</span></span><br><span class="line">	__HAL_RCC_GPIOB_CLK_ENABLE();			<span class="comment">//开启GPIOB时钟</span></span><br><span class="line"></span><br><span class="line">	GPIO_Initure.Pin = GPIO_PIN_12|GPIO_PIN_13|GPIO_PIN_14|GPIO_PIN_15;	<span class="comment">//端口配置</span></span><br><span class="line">	GPIO_Initure.Pull = GPIO_NOPULL;</span><br><span class="line">	GPIO_Initure.Mode = GPIO_MODE_OUTPUT_PP;	  						<span class="comment">//推挽输出</span></span><br><span class="line">	GPIO_Initure.Speed = GPIO_SPEED_FREQ_HIGH;					 <span class="comment">//50M</span></span><br><span class="line">	</span><br><span class="line">	HAL_GPIO_Init(GPIOB, &amp;GPIO_Initure);				  <span class="comment">//根据设定参数初始化GPIOB </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是对PWM外设的<strong>初始化</strong>，这里<strong>用定时器1的1、4通道</strong>，映射到PA8和PA11两个引脚用来控制两个电机的转速：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//TIM1 PWM初始化 </span></span><br><span class="line"><span class="comment">//arr：自动重装值。</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="comment">//定时器溢出时间计算方法:Tout=((arr+1)*(psc+1))/Ft us.</span></span><br><span class="line"><span class="comment">//Ft=定时器工作频率,单位:Mhz</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MiniBalance_PWM_Init</span><span class="params">(u16 arr,u16 psc)</span>		<span class="comment">//完成两个PWM输出引脚的初始化</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TIM1_Handler.Instance=TIM1;							<span class="comment">//定时器1</span></span><br><span class="line">	TIM1_Handler.Init.Prescaler=psc;					<span class="comment">//定时器分频</span></span><br><span class="line">	TIM1_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;	<span class="comment">//向上计数模式</span></span><br><span class="line">	TIM1_Handler.Init.Period=arr;		 				<span class="comment">//自动重装载值</span></span><br><span class="line">	TIM1_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;</span><br><span class="line">	HAL_TIM_PWM_Init(&amp;TIM1_Handler);	  			 <span class="comment">//初始化PWM</span></span><br><span class="line">	</span><br><span class="line">	TIM1_CH14Handler.OCMode=TIM_OCMODE_PWM1;		 	<span class="comment">//模式选择PWM1</span></span><br><span class="line">	TIM1_CH14Handler.Pulse= <span class="number">0</span>;						<span class="comment">//设置比较值,初始占空比设为0</span></span><br><span class="line">	TIM1_CH14Handler.OCPolarity=TIM_OCPOLARITY_HIGH; 	<span class="comment">//输出极性 高电平有效 </span></span><br><span class="line">	HAL_TIM_PWM_ConfigChannel(&amp;TIM1_Handler,&amp;TIM1_CH14Handler,TIM_CHANNEL_1);<span class="comment">//初始化TIM1，PWM通道1、4</span></span><br><span class="line">	HAL_TIM_PWM_ConfigChannel(&amp;TIM1_Handler,&amp;TIM1_CH14Handler,TIM_CHANNEL_4);<span class="comment">//初始化TIM1，PWM通道1、4</span></span><br><span class="line">	</span><br><span class="line">	HAL_TIM_PWM_Start(&amp;TIM1_Handler,TIM_CHANNEL_1);	<span class="comment">//开启PWM通道1、4</span></span><br><span class="line">	HAL_TIM_PWM_Start(&amp;TIM1_Handler,TIM_CHANNEL_4);	<span class="comment">//开启PWM通道1、4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在HAL_TIM_PWM_Init()中会调用端口初始化<strong>MSP函数</strong>，需要用户重定义覆盖HAL库的若定义函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定时器底层驱动，时钟使能，引脚配置</span></span><br><span class="line"><span class="comment">//此函数会被HAL_TIM_PWM_Init()调用</span></span><br><span class="line"><span class="comment">//htim:定时器句柄</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PWM_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">	</span><br><span class="line">    <span class="keyword">if</span>(htim-&gt;Instance==TIM1)</span><br><span class="line">	&#123;</span><br><span class="line">		__HAL_RCC_TIM1_CLK_ENABLE();			<span class="comment">//使能TIM1时钟</span></span><br><span class="line">		__HAL_AFIO_REMAP_TIM1_PARTIAL();		<span class="comment">//TIM1通道引脚部分重映射使能</span></span><br><span class="line">		__HAL_RCC_GPIOA_CLK_ENABLE();			<span class="comment">//开启GPIOA时钟</span></span><br><span class="line">		</span><br><span class="line">		GPIO_Initure.Pin=GPIO_PIN_8|GPIO_PIN_11;           	<span class="comment">//PA8 PA11</span></span><br><span class="line">		GPIO_Initure.Mode=GPIO_MODE_AF_PP;  	<span class="comment">//复用推挽输出,用于输出PWM</span></span><br><span class="line">		GPIO_Initure.Pull=GPIO_PULLDOWN;          <span class="comment">//下拉</span></span><br><span class="line">		GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;<span class="comment">//高速</span></span><br><span class="line">		HAL_GPIO_Init(GPIOA,&amp;GPIO_Initure); 	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后是中断服务函数，等等，我们设置了自动重装填，不需要中断控制，OK结束。</p>
<h2 id="实践4：定时器的输入捕获模式（结合超声波模块）"><a href="#实践4：定时器的输入捕获模式（结合超声波模块）" class="headerlink" title="实践4：定时器的输入捕获模式（结合超声波模块）"></a>实践4：定时器的输入捕获模式（结合超声波模块）</h2><h3 id="定时器初始化"><a href="#定时器初始化" class="headerlink" title="定时器初始化"></a>定时器初始化</h3><h4 id="us015timer-h"><a href="#us015timer-h" class="headerlink" title="us015timer.h"></a>us015timer.h</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _US015TIMER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _US015TIMER_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"sys.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_CH3_Cap_Init</span><span class="params">(u32 arr,u16 psc)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h4 id="us015timer-c"><a href="#us015timer-c" class="headerlink" title="us015timer.c"></a>us015timer.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"us015timer.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  PC8---Echo     TIM3 CH3 </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//TIM3  捕获初始化</span></span><br><span class="line">TIM_HandleTypeDef TIM3_Handler;         <span class="comment">//定时器3句柄</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器2通道1输入捕获配置</span></span><br><span class="line"><span class="comment">//arr：自动重装值(TIM3是16位的!!)</span></span><br><span class="line"><span class="comment">//psc：时钟预分频数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_CH3_Cap_Init</span><span class="params">(u32 arr,u16 psc)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    TIM_IC_InitTypeDef TIM3_CH3Config;  </span><br><span class="line">    </span><br><span class="line">    TIM3_Handler.Instance=TIM3;                          <span class="comment">//通用定时器3</span></span><br><span class="line">    TIM3_Handler.Init.Prescaler=psc;                     <span class="comment">//分频系数</span></span><br><span class="line">    TIM3_Handler.Init.CounterMode=TIM_COUNTERMODE_UP;    <span class="comment">//向上计数器</span></span><br><span class="line">    TIM3_Handler.Init.Period=arr;                        <span class="comment">//自动装载值</span></span><br><span class="line">    TIM3_Handler.Init.ClockDivision=TIM_CLOCKDIVISION_DIV1;<span class="comment">//时钟分频因子</span></span><br><span class="line">   	TIM3_Handler.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_ENABLE;<span class="comment">//使能自动重载</span></span><br><span class="line">    HAL_TIM_IC_Init(&amp;TIM3_Handler);						<span class="comment">//初始化输入捕获时基参数</span></span><br><span class="line">    </span><br><span class="line">    TIM3_CH3Config.ICPolarity=TIM_ICPOLARITY_RISING;    <span class="comment">//上升沿捕获</span></span><br><span class="line">    TIM3_CH3Config.ICSelection=TIM_ICSELECTION_DIRECTTI;<span class="comment">//映射到TI1上</span></span><br><span class="line">    TIM3_CH3Config.ICPrescaler=TIM_ICPSC_DIV1;          <span class="comment">//配置输入分频，不分频</span></span><br><span class="line">    TIM3_CH3Config.ICFilter=<span class="number">0</span>;                          <span class="comment">//配置输入滤波器，不滤波</span></span><br><span class="line">    HAL_TIM_IC_ConfigChannel(&amp;TIM3_Handler,&amp;TIM3_CH3Config,TIM_CHANNEL_3);<span class="comment">//配置TIM3通道3</span></span><br><span class="line">	</span><br><span class="line">    HAL_TIM_IC_Start_IT(&amp;TIM3_Handler,TIM_CHANNEL_3);   <span class="comment">//开启TIM3的捕获通道3，并且开启捕获中断</span></span><br><span class="line">    __HAL_TIM_ENABLE_IT(&amp;TIM3_Handler,TIM_IT_UPDATE);   <span class="comment">//使能更新中断</span></span><br><span class="line">	</span><br><span class="line">	HAL_NVIC_SetPriority(TIM3_IRQn,<span class="number">2</span>,<span class="number">0</span>);    <span class="comment">//设置中断优先级，抢占优先级2，子优先级0</span></span><br><span class="line">    HAL_NVIC_EnableIRQ(TIM3_IRQn);          <span class="comment">//开启ITM3中断通道  </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器2底层驱动，时钟使能，引脚配置</span></span><br><span class="line"><span class="comment">//此函数会被HAL_TIM_IC_Init()调用</span></span><br><span class="line"><span class="comment">//htim:定时器2句柄</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_MspInit</span><span class="params">(TIM_HandleTypeDef *htim)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    GPIO_InitTypeDef GPIO_Initure;</span><br><span class="line">    __HAL_RCC_TIM3_CLK_ENABLE();            <span class="comment">//使能TIM3时钟</span></span><br><span class="line">    __HAL_AFIO_REMAP_TIM3_ENABLE();	</span><br><span class="line">	  __HAL_RCC_GPIOC_CLK_ENABLE();			<span class="comment">//开启GPIOC时钟</span></span><br><span class="line">	</span><br><span class="line">    GPIO_Initure.Pin=GPIO_PIN_8;            <span class="comment">//PC8</span></span><br><span class="line">    GPIO_Initure.Mode=GPIO_MODE_AF_INPUT; 	<span class="comment">//复用推挽输入</span></span><br><span class="line">    GPIO_Initure.Pull=GPIO_PULLDOWN;        <span class="comment">//下拉</span></span><br><span class="line">    GPIO_Initure.Speed=GPIO_SPEED_FREQ_HIGH;     <span class="comment">//高速</span></span><br><span class="line">    HAL_GPIO_Init(GPIOC,&amp;GPIO_Initure);</span><br><span class="line"></span><br><span class="line">    HAL_NVIC_SetPriority(TIM3_IRQn,<span class="number">2</span>,<span class="number">0</span>);    <span class="comment">//设置中断优先级，抢占优先级2，子优先级0</span></span><br><span class="line">    HAL_NVIC_EnableIRQ(TIM3_IRQn);          <span class="comment">//开启ITM3中断通道  </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//捕获状态</span></span><br><span class="line"><span class="comment">//[7]:0,没有成功的捕获;1,成功捕获到一次.</span></span><br><span class="line"><span class="comment">//[6]:0,还没捕获到低电平;1,已经捕获到低电平了.</span></span><br><span class="line"><span class="comment">//[5:0]:捕获低电平后溢出的次数</span></span><br><span class="line">u8  TIM3CH3_CAPTURE_STA=<span class="number">0</span>;							<span class="comment">//输入捕获状态		    				</span></span><br><span class="line">u16	TIM3CH3_CAPTURE_VAL;							  <span class="comment">//输入捕获值(TIM3是16位)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器2中断服务函数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">TIM3_IRQHandler</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	HAL_TIM_IRQHandler(&amp;TIM3_Handler);				<span class="comment">//定时器共用处理函数</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment">//定时器更新中断（计数溢出）中断处理回调函数， 该函数在HAL_TIM_IRQHandler中会被调用,实现多个计数器满装载的计数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_PeriodElapsedCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span><span class="comment">//更新中断（溢出）发生时执行</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>((TIM3CH3_CAPTURE_STA&amp;<span class="number">0X80</span>)==<span class="number">0</span>)				<span class="comment">//还未成功捕获上升沿</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(TIM3CH3_CAPTURE_STA&amp;<span class="number">0X40</span>)				<span class="comment">//已经捕获到高电平了</span></span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>((TIM3CH3_CAPTURE_STA&amp;<span class="number">0X3F</span>)==<span class="number">0X3F</span>)	<span class="comment">//高电平太长了</span></span><br><span class="line">			&#123;</span><br><span class="line">				TIM3CH3_CAPTURE_STA|=<span class="number">0X80</span>;			<span class="comment">//标记成功捕获了一次</span></span><br><span class="line">				TIM3CH3_CAPTURE_VAL=<span class="number">0XFFFF</span>;</span><br><span class="line">			&#125;<span class="keyword">else</span> TIM3CH3_CAPTURE_STA++;</span><br><span class="line">		&#125;	 </span><br><span class="line">	&#125;		</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//定时器输入捕获中断处理回调函数，该函数在HAL_TIM_IRQHandler中会被调用</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_IC_CaptureCallback</span><span class="params">(TIM_HandleTypeDef *htim)</span><span class="comment">//捕获中断发生时执行</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span>((TIM3CH3_CAPTURE_STA&amp;<span class="number">0X80</span>)==<span class="number">0</span>)				<span class="comment">//还未成功捕获</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(TIM3CH3_CAPTURE_STA&amp;<span class="number">0X40</span>)				<span class="comment">//捕获到一个下降沿 		</span></span><br><span class="line">		&#123;	  			</span><br><span class="line">			TIM3CH3_CAPTURE_STA|=<span class="number">0X80</span>;				<span class="comment">//标记成功捕获到一次高电平脉宽</span></span><br><span class="line">            TIM3CH3_CAPTURE_VAL=HAL_TIM_ReadCapturedValue(&amp;TIM3_Handler,TIM_CHANNEL_3);<span class="comment">//获取当前的捕获值.</span></span><br><span class="line">			TIM_RESET_CAPTUREPOLARITY(&amp;TIM3_Handler,TIM_CHANNEL_3);   <span class="comment">//一定要先清除原来的设置！！</span></span><br><span class="line">            TIM_SET_CAPTUREPOLARITY(&amp;TIM3_Handler,TIM_CHANNEL_3,TIM_ICPOLARITY_RISING);<span class="comment">//配置TIM3通道3上升沿捕获</span></span><br><span class="line">		&#125;<span class="keyword">else</span>  										<span class="comment">//还未开始,第一次捕获上升沿</span></span><br><span class="line">		&#123;</span><br><span class="line">			TIM3CH3_CAPTURE_STA=<span class="number">0</span>;					<span class="comment">//清空</span></span><br><span class="line">			TIM3CH3_CAPTURE_VAL=<span class="number">0</span>;</span><br><span class="line">			TIM3CH3_CAPTURE_STA|=<span class="number">0X40</span>;				<span class="comment">//标记捕获到了上升沿</span></span><br><span class="line">			__HAL_TIM_DISABLE(&amp;TIM3_Handler);      	<span class="comment">//关闭定时器3</span></span><br><span class="line">			__HAL_TIM_SET_COUNTER(&amp;TIM3_Handler,<span class="number">0</span>);</span><br><span class="line">			TIM_RESET_CAPTUREPOLARITY(&amp;TIM3_Handler,TIM_CHANNEL_3);   <span class="comment">//一定要先清除原来的设置！！</span></span><br><span class="line">			TIM_SET_CAPTUREPOLARITY(&amp;TIM3_Handler,TIM_CHANNEL_3,TIM_ICPOLARITY_FALLING);<span class="comment">//定时器3通道3设置为下降沿捕获</span></span><br><span class="line">			__HAL_TIM_ENABLE(&amp;TIM3_Handler);		<span class="comment">//使能定时器3</span></span><br><span class="line">		&#125;		    </span><br><span class="line">	&#125;		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里由于篇幅因素，只展示定时器的设置，端口设置另一个下拉高速推挽输出，实现对超声波模块的触发即可。</p>
<p>这个要比输出PWM要复杂一点，主要多了中断服务函数，以及中断回调函数上，因为超声波模块要求在接收到一个上升沿的回声数据之后立刻进行数据的处理，便于在主循环或者其他中断中实现相应的避障操作。</p>
<h2 id="实践5：定时器的编码器模式"><a href="#实践5：定时器的编码器模式" class="headerlink" title="实践5：定时器的编码器模式"></a>实践5：定时器的编码器模式</h2><p>对于编码电机，以前用51这种功能简单的单片机，只能使用定时器，配合特定的编码器解算算法，才能得到相对精确的电机码盘信息，但是STM32的通用定时器和高级定时器，自带编码器模式，简直是太方便了，如图：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200531123617299.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="编码器接口模式"></p>
<p>通过描述，可以看到，我们可以通过配置通用定时器的一个通道，实现单编码器的读取，也可以通过设置一个定时器的12两个通道，相当于硬件四倍频技术，实现高精度的编码器读取。</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200531123510994.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="编码器模式"></p>
<h3 id="编码器模式的配置"><a href="#编码器模式的配置" class="headerlink" title="编码器模式的配置"></a>编码器模式的配置</h3><p>这一次我使用cubeMX进行配置，使配置过程简单明了：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200531131159782.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="编码器cubeMX配置"></p>
<ol>
<li>GPIO引脚复用为高级定时器TIM1的两个通道CH1，CH2</li>
<li>选择定时器1模式为：编码器模式</li>
<li>分频：不分频</li>
<li>计数值：0xFFFF，取最大，减小循环误差（我认为是这样的）</li>
<li>很重要，使用12双通道，进行AB相正交编码器的硬件四倍频。</li>
</ol>
<p>生成代码（记得勾选生成独立的h文件和C文件）：</p>
<h3 id="tim-h"><a href="#tim-h" class="headerlink" title="tim.h"></a>tim.h</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> __tim_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> __tim_H</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line"> <span class="keyword">extern</span> <span class="string">"C"</span> &#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"main.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> TIM_HandleTypeDef htim1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_TIM1_Init</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="tim-c"><a href="#tim-c" class="headerlink" title="tim.c"></a>tim.c</h3><p>我把原来cubeMX的注释删掉了，省略了MSP的失能函数，在重要的语句后面写了自己的注释：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Includes ------------------------------------------------------------------*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"tim.h"</span></span></span><br><span class="line"></span><br><span class="line">TIM_HandleTypeDef htim1;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MX_TIM1_Init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  TIM_Encoder_InitTypeDef sConfig = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  TIM_MasterConfigTypeDef sMasterConfig = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">  htim1.Instance = TIM1;</span><br><span class="line">  htim1.Init.Prescaler = <span class="number">0</span>;										<span class="comment">//计数频率：不分频</span></span><br><span class="line">  htim1.Init.CounterMode = TIM_COUNTERMODE_UP;					<span class="comment">//向上计数</span></span><br><span class="line">  htim1.Init.Period = <span class="number">65535</span>;									<span class="comment">//计数值0xFFFF</span></span><br><span class="line">  htim1.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;			<span class="comment">//时钟预分频器：不分频</span></span><br><span class="line">  htim1.Init.RepetitionCounter = <span class="number">0</span>;								<span class="comment">//计数初值？</span></span><br><span class="line">  htim1.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;<span class="comment">//重装失能</span></span><br><span class="line">  sConfig.EncoderMode = TIM_ENCODERMODE_TI12;					<span class="comment">//通道12，硬件四倍频</span></span><br><span class="line"> <span class="comment">//通道1</span></span><br><span class="line">  sConfig.IC1Polarity = TIM_ICPOLARITY_RISING;					<span class="comment">//捕获极性：高</span></span><br><span class="line">  sConfig.IC1Selection = TIM_ICSELECTION_DIRECTTI;</span><br><span class="line">  sConfig.IC1Prescaler = TIM_ICPSC_DIV1;						<span class="comment">//通道时钟分频：不分频</span></span><br><span class="line">  sConfig.IC1Filter = <span class="number">0</span>;										<span class="comment">//硬件滤波：不滤波</span></span><br><span class="line"> <span class="comment">//通道2</span></span><br><span class="line">  sConfig.IC2Polarity = TIM_ICPOLARITY_RISING;					</span><br><span class="line">  sConfig.IC2Selection = TIM_ICSELECTION_DIRECTTI;</span><br><span class="line">  sConfig.IC2Prescaler = TIM_ICPSC_DIV1;</span><br><span class="line">  sConfig.IC2Filter = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (HAL_TIM_Encoder_Init(&amp;htim1, &amp;sConfig) != HAL_OK)</span><br><span class="line">  &#123;</span><br><span class="line">    Error_Handler();</span><br><span class="line">  &#125;</span><br><span class="line">  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;</span><br><span class="line">  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;</span><br><span class="line">  <span class="keyword">if</span> (HAL_TIMEx_MasterConfigSynchronization(&amp;htim1, &amp;sMasterConfig) != HAL_OK)</span><br><span class="line">  &#123;</span><br><span class="line">    Error_Handler();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//MSP初始化函数：被HAL_TIM_Encoder_Init调用，用于配置对应的引脚映射</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">HAL_TIM_Encoder_MspInit</span><span class="params">(TIM_HandleTypeDef* tim_encoderHandle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">  GPIO_InitTypeDef GPIO_InitStruct = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">  <span class="keyword">if</span>(tim_encoderHandle-&gt;Instance==TIM1)</span><br><span class="line">  &#123;</span><br><span class="line">    __HAL_RCC_TIM1_CLK_ENABLE();					<span class="comment">//定时器1时钟使能</span></span><br><span class="line">    __HAL_RCC_GPIOA_CLK_ENABLE();					<span class="comment">//GPIOA时钟使能</span></span><br><span class="line"></span><br><span class="line">    GPIO_InitStruct.Pin = GPIO_PIN_8|GPIO_PIN_9;	<span class="comment">//8，9引脚</span></span><br><span class="line">    GPIO_InitStruct.Mode = GPIO_MODE_INPUT;			<span class="comment">//输入模式</span></span><br><span class="line">    GPIO_InitStruct.Pull = GPIO_NOPULL;				<span class="comment">//无上下拉</span></span><br><span class="line">    HAL_GPIO_Init(GPIOA, &amp;GPIO_InitStruct);			<span class="comment">//GPIO初始化</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/19/%E5%BE%AE%E7%A7%AF%E5%88%86%E5%B8%B8%E7%94%A8%E5%85%AC%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/19/%E5%BE%AE%E7%A7%AF%E5%88%86%E5%B8%B8%E7%94%A8%E5%85%AC%E5%BC%8F/" itemprop="url">微积分常用公式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-19T17:54:06+08:00">
                2020-05-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="极限"><a href="#极限" class="headerlink" title="极限"></a>极限</h2>
$$
\begin{array}{*{20}{l}}
{\begin{array}{*{20}{c}}
{C}&{\text{常}\text{数}}\\
{f{ \left( {x} \right) }}&{\text{函}\text{数}}\\
{n}&{\text{正}\text{整}\text{数}}\\
{ \left\{ {\mathop{{x}}\nolimits_{{n}}} \left\} ,{ \left\{ {\mathop{{y}}\nolimits_{{n}}} \right\} }\right. \right. }&{\text{数}\text{列}}
\end{array}}\\
{ \text{lim} { \left[ {Cf{ \left( {x} \right) }} \left] =C{ \left[ { \text{lim} f{ \left( {x} \right) }} \right] }\right. \right. }}\\
{ \text{lim} {\mathop{{ \left[ {f{ \left( {x} \right) }} \right] }}\nolimits^{{n}}}={\mathop{{ \left[ { \text{lim} f{ \left( {x} \right) }} \right] }}\nolimits^{{n}}}}\\
{\mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}{ \left( {\mathop{{x}}\nolimits_{{n}} \pm \mathop{{y}}\nolimits_{{n}}} \right) }=\mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}\mathop{{x}}\nolimits_{{n}} \pm \mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}\mathop{{y}}\nolimits_{{n}}}\\
{\mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}{ \left( {\mathop{{x}}\nolimits_{{n}} \cdot \mathop{{y}}\nolimits_{{n}}} \right) }=\mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}\mathop{{x}}\nolimits_{{n}} \cdot \mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}\mathop{{y}}\nolimits_{{n}}}\\
{\mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}{ \left( {\frac{{\mathop{{x}}\nolimits_{{n}}}}{{\mathop{{y}}\nolimits_{{n}}}}} \right) }=\frac{{\mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}\mathop{{x}}\nolimits_{{n}}}}{{\mathop{{ \text{lim} }}\limits_{{n \to + \text{ \infty } }}\mathop{{y}}\nolimits_{{n}}}},{ \left( {\mathop{{y}}\nolimits_{{n}} \neq 0,n=1,2,3, \cdots } \right) }}
\end{array}
$$

<h2 id="洛必达法则"><a href="#洛必达法则" class="headerlink" title="洛必达法则"></a>洛必达法则</h2>
$$
\begin{array}{*{20}{l}}
{\text{若}\text{函}\text{数}f{ \left( {x} \left) ,g{ \left( {x} \right) }\text{满}\text{足}\text{如}\text{下}\text{条}\text{件}\text{:}\right. \right. }}\\
{\mathop{{ \text{lim} }}\limits_{{x \to a}}f{ \left( {x} \right) }=0,\mathop{{ \text{lim} }}\limits_{{x \to a}}g{ \left( {x} \right) }=0}\\
{\text{在}\text{点}a\text{的}\text{某}\text{去}\text{邻}\text{域}\text{内}f{ \left( {x} \left) \text{和}g{ \left( {x} \right) }\text{都}\text{可}\text{导}\text{,}\text{且}{g} \prime { \left( {x} \left)  \neq 0\right. \right. }\right. \right. }}\\
{\mathop{{ \text{lim} }}\limits_{{x \to a}}\frac{{f \prime { \left( {x} \right) }}}{{g \prime { \left( {x} \right) }}}=A,{ \left( {A\text{为}\text{实}\text{数}} \right) }}\\
{\text{则}\text{有}}\\
{\mathop{{ \text{lim} }}\limits_{{x \to a}}\frac{{f{ \left( {x} \right) }}}{{g{ \left( {x} \right) }}}=\mathop{{ \text{lim} }}\limits_{{x \to a}}\frac{{f \prime { \left( {x} \right) }}}{{g \prime { \left( {x} \right) }}}=A}
\end{array}
$$

$$
\begin{array}{*{20}{l}}
{\text{若}\text{函}\text{数}f{ \left( {x} \left) ,g{ \left( {x} \right) }\text{满}\text{足}\text{如}\text{下}\text{条}\text{件}\text{:}\right. \right. }}\\
{\mathop{{ \text{lim} }}\limits_{{x \to a}}f{ \left( {x} \right) }= \infty ,\mathop{{ \text{lim} }}\limits_{{x \to a}}g{ \left( {x} \right) }= \infty }\\
{\text{在}\text{点}a\text{的}\text{某}\text{去}\text{邻}\text{域}\text{内}f{ \left( {x} \left) \text{和}g{ \left( {x} \right) }\text{都}\text{可}\text{导}\text{,}\text{且}{g} \prime { \left( {x} \left)  \neq 0\right. \right. }\right. \right. }}\\
{\mathop{{ \text{lim} }}\limits_{{x \to a}}\frac{{f \prime { \left( {x} \right) }}}{{g \prime { \left( {x} \right) }}}=A,{ \left( {A\text{为}\text{实}\text{数}\text{,}\text{也}\text{可}\text{为} \pm  \infty \text{或} \infty } \right) }}\\
{\text{则}\text{有}}\\
{\mathop{{ \text{lim} }}\limits_{{x \to a}}\frac{{f{ \left( {x} \right) }}}{{g{ \left( {x} \right) }}}=\mathop{{ \text{lim} }}\limits_{{x \to a}}\frac{{f \prime { \left( {x} \right) }}}{{g \prime { \left( {x} \right) }}}=A}
\end{array}
$$

<h2 id="基本求导法则"><a href="#基本求导法则" class="headerlink" title="基本求导法则"></a>基本求导法则</h2>
$$
\begin{array}{*{20}{l}}
{ \left( {C} \left)  \prime =0\right. \right. }\\
{ \left( {\mathop{{x}}\nolimits^{{ \mu }}} \left)  \prime = \mu \mathop{{x}}\nolimits^{{ \mu -1}}\right. \right. }\\

\\

{ \left( { \text{sin} x} \left)  \prime = \text{cos} x\right. \right. }\\
{ \left( { \text{cos} x} \left)  \prime =- \text{sin} x\right. \right. }\\
{ \left( { \text{tan} x} \left)  \prime =\mathop{{ \text{sec} }}\nolimits^{{2}}x\right. \right. }\\
{ \left( { \text{cot} x} \left)  \prime =-\mathop{{ \text{csc} }}\nolimits^{{2}}x\right. \right. }\\
{ \left( { \text{sec} x} \left)  \prime = \text{sec} x \text{tan} x\right. \right. }\\
{ \left( { \text{csc} x} \left)  \prime =- \text{csc} x{ \text{cot} x}\right. \right. }\\

\\

{ \left( {\mathop{{a}}\nolimits^{{x}}} \left)  \prime =\mathop{{a}}\nolimits^{{x}} \text{ln} a\right. \right. }\\
{ \left( {\mathop{{e}}\nolimits^{{x}}} \left)  \prime =\mathop{{e}}\nolimits^{{x}}\right. \right. }\\
{ \left( {\mathop{{ \text{log} }}\nolimits_{{a}}x} \left)  \prime =\frac{{1}}{{x \text{ln} a}}\right. \right. }\\
{ \left( { \text{ln} a} \left)  \prime =\frac{{1}}{{x}}\right. \right. }\\

\\

{ \left( { \text{arcsin} x} \left)  \prime =\frac{{1}}{{\sqrt{{1-\mathop{{x}}\nolimits^{{2}}}}}}\right. \right. }\\
{ \left( { \text{arccos} x} \left)  \prime =-\frac{{1}}{{\sqrt{{1-\mathop{{x}}\nolimits^{{2}}}}}}\right. \right. }\\
{ \left( { \text{arctan} x} \left)  \prime =\frac{{1}}{{1+\mathop{{x}}\nolimits^{{2}}}}\right. \right. }\\
{ \left( { \text{arccot} x} \left)  \prime =-\frac{{1}}{{1+\mathop{{x}}\nolimits^{{2}}}}\right. \right. }\\

\\



\end{array}
$$

<h2 id="不定积分"><a href="#不定积分" class="headerlink" title="不定积分"></a>不定积分</h2>
$$
\begin{array}{*{20}{l}}
{{}_{ }^{ } \int _{ }^{ }k \text{d} x=kx+C}\\
{{}_{ }^{ } \int _{ }^{ }\mathop{{x}}\nolimits^{{ \mu }} \text{d} x=\frac{{\mathop{{x}}\nolimits^{{ \mu +1}}}}{{ \mu +1}}+C,{ \left( { \mu  \neq -1} \right) }}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{x}} \text{d} x= \text{ln} { \left| {x} \right| }+C}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{1+\mathop{{x}}\nolimits^{{2}}}} \text{d} x= \text{arctan} x+C}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\sqrt{{1-\mathop{{x}}\nolimits^{{2}}}}}} \text{d} x= \text{arcsin} x+C}\\

\\

{{}_{ }^{ } \int _{ }^{ } \text{cos}  \text{d} x= \text{sin} x+C}\\
{{}_{ }^{ } \int _{ }^{ } \text{sin} x \text{d} x=- \text{cos} x+C}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\mathop{{ \text{cos} }}\nolimits^{{2}}x}} \text{d} x={}_{ }^{ } \int _{ }^{ }\mathop{{ \text{sec} }}\nolimits^{{2}}x \text{d} x= \text{tan} x+C}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\mathop{{ \text{sin} }}\nolimits^{{2}}x}} \text{d} x={}_{ }^{ } \int _{ }^{ }\mathop{{ \text{csc} }}\nolimits^{{2}}x \text{d} x=- \text{cot} x+C}\\
{{}_{ }^{ } \int _{ }^{ } \text{sec} x \text{tan} x \text{d} x= \text{sec} x+C}\\
{{}_{ }^{ } \int _{ }^{ } \text{csc} x \text{cot} x \text{d} x=- \text{csc} x+C}\\

\\

{{}_{ }^{ } \int _{ }^{ }\mathop{{e}}\nolimits^{{x}} \text{d} x=\mathop{{e}}\nolimits^{{x}}+C}\\
{{}_{ }^{ } \int _{ }^{ }\mathop{{a}}\nolimits^{{x}} \text{d} x=\frac{{\mathop{{a}}\nolimits^{{x}}}}{{ \text{ln} a}}+C}\\
{{}_{ }^{ } \int _{ }^{ } \text{sh} x \text{d} x= \text{ch} x+C}\\
{{}_{ }^{ } \int _{ }^{ } \text{ch} xdx= \text{sh} x+C}\\

\\

{{}_{ }^{ } \int _{ }^{ } \text{tan} x \text{d} x=- \text{ln} { \left| { \text{cos} x} \right| }+C}\\
{{}_{ }^{ } \int _{ }^{ } \text{cot} x \text{d} x= \text{ln} { \left| { \text{sin} x} \right| }+C}\\
{{}_{ }^{ } \int _{ }^{ } \text{sec} x \text{d} x= \text{ln} { \left| { \text{sec} x+ \text{tan} x} \right| }+C}\\
{{}_{ }^{ } \int _{ }^{ } \text{csc} x \text{d} x= \text{ln} { \left| { \text{csc} x- \text{cot} x} \right| }+C}\\

\\

{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\mathop{{x}}\nolimits^{{2}}+\mathop{{a}}\nolimits^{{2}}}} \text{d} x=\frac{{1}}{{a}} \text{arctan} \frac{{x}}{{a}}+C}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\mathop{{x}}\nolimits^{{2}}-\mathop{{a}}\nolimits^{{2}}}} \text{d} x=\frac{{1}}{{2a}} \text{ln} { \left| {\frac{{x-a}}{{x+a}}} \right| }+C}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\sqrt{{\mathop{{a}}\nolimits^{{2}}-\mathop{{x}}\nolimits^{{2}}}}}} \text{d} x= \text{arcsin} \frac{{x}}{{a}}+C}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\sqrt{{\mathop{{x}}\nolimits^{{2}}+\mathop{{a}}\nolimits^{{2}}}}}} \text{d} x= \text{ln} { \left( {x+\sqrt{{\mathop{{x}}\nolimits^{{2}}+\mathop{{a}}\nolimits^{{2}}}}} \right) }+C}\\
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\sqrt{{\mathop{{x}}\nolimits^{{2}}-\mathop{{a}}\nolimits^{{2}}}}}} \text{d} x= \text{ln} { \left( {x+\sqrt{{\mathop{{x}}\nolimits^{{2}}\mathop{{a}}\nolimits^{{2}}}}} \right) }+C}\\

\end{array}
$$

<h2 id="定积分"><a href="#定积分" class="headerlink" title="定积分"></a>定积分</h2>
$$
\begin{array}{*{20}{l}}
a=b \Rightarrow \mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x=0\\

\mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x=-\mathop{ \int }\nolimits_{{b}}^{{a}}f{ \left( {x} \right) } \text{d} x\\

\mathop{ \int }\nolimits_{{a}}^{{b}}{ \left[ {f{ \left( {x} \right) } \pm g{ \left( {x} \right) }} \right] } \text{d} x=\mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x \pm \mathop{ \int }\nolimits_{{a}}^{{b}}g{ \left( {x} \right) } \text{d} x\\

\mathop{ \int }\nolimits_{{a}}^{{b}}kf{ \left( {x} \right) } \text{d} x=k\mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x\\

\mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x=\mathop{ \int }\nolimits_{{a}}^{{c}}f{ \left( {x} \right) } \text{d} x+\mathop{ \int }\nolimits_{{c}}^{{b}}f{ \left( {x} \right) } \text{d} x, \forall c \in { \left( {a,b} \right) }\\

\mathop{ \int }\nolimits_{{a}}^{{b}} \text{d} x=b-a\\

f{ \left( {x} \right) } \ge 0,x \in { \left[ {a,b} \right] } \Rightarrow \mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x \ge 0\\

f{ \left( {x} \right) } \ge g{ \left( {x} \right) },x \in { \left[ {a,b} \right] } \Rightarrow \mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x \ge \mathop{ \int }\nolimits_{{a}}^{{b}}g{ \left( {x} \right) } \text{d} x\\

a < b \Rightarrow { \left| {\mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x} \right| } \le \mathop{ \int }\nolimits_{{a}}^{{b}}{ \left| {f{ \left( {x} \right) } \text{d} x} \right| }\\

\\

{M=\mathop{{f}}\nolimits_{{max}}{ \left( {x} \right) },m=\mathop{{f}}\nolimits_{{min}}{ \left( {x} \right) },x \in { \left[ {a,b} \right] }}\\
{m{ \left( {b-a} \right) } \le \mathop{ \int }\nolimits_{{a}}^{{b}}f{ \left( {x} \right) } \text{d} x \le M{ \left( {b-a} \right) }}
\end{array}
$$

$$
{{}_{ }^{ } \int _{ }^{ }\frac{{1}}{{\sqrt{{\mathop{{x}}\nolimits^{{2}}-\mathop{{a}}\nolimits^{{2}}}}}} \text{d} x= \text{ln} { \left( {x+\sqrt{{\mathop{{x}}\nolimits^{{2}}\mathop{{a}}\nolimits^{{2}}}}} \right) }+C}
$$

$$
\int {\frac{1}{{\sqrt {{x^2} - {a^2}} }}dx}  = {\text{ln}}\left( {x + \sqrt {{x^2}{a^2}} } \right) + C
$$

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/19/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/19/hello-world/" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-19T17:54:06+08:00">
                2020-05-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/one-command-deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/19/hexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/19/hexo%E6%90%AD%E5%BB%BA%E5%8D%9A%E5%AE%A2%E7%96%91%E9%9A%BE%E6%9D%82%E7%97%87/" itemprop="url">hexo搭建博客疑难杂症</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-19T17:54:06+08:00">
                2020-05-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="菜单栏点击出现的404问题"><a href="#菜单栏点击出现的404问题" class="headerlink" title="菜单栏点击出现的404问题"></a>菜单栏点击出现的404问题</h3><p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200419012124265.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="恼人的菜单404"></p>
<p>为什么总是404呢，明明已经去掉了注释，添加了index.md文件，添加了type类型，怎么还是404？</p>
<p>其实，在出现404界面之前，会短暂地显示CannotGetFile 20%</p>
<p>看出一点端倪了吗？20%正是URL编码中的空格。回忆一下，哪里有空格呢？</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200419012138981.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>对了，把这些空格怒删，问题就迎刃而解了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/12/HAL%E5%BA%93%E7%9A%84%E7%AC%AC1%E4%B8%AA%E5%9D%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Silicon4">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Silicon4">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/12/HAL%E5%BA%93%E7%9A%84%E7%AC%AC1%E4%B8%AA%E5%9D%91/" itemprop="url">HAL库的第一个坑</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-12T17:22:51+08:00">
                2020-05-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/STM32%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index">
                    <span itemprop="name">STM32学习记录</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我居然想不到，有生之年可以遇到官方的HAL库出Bug，一个困扰我两天的问题，疯狂找手册，看寄存器，深究HAL库底层，到最后居然是一个函数宏出了问题？</p>
<p>直接说吧，我为了用超声波模块，学基本定时器的捕获模式，要用到清除捕获极性，HAL库提供了这么一个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TIM_RESET_CAPTUREPOLARITY(A, B);</span><br><span class="line"><span class="comment">/*A：要设置捕获极性的定时器句柄    B：捕获的定时器通道*/</span></span><br></pre></td></tr></table></figure>
<p>写到这一句，编译，就是这个样子：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/2020051320253898.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="HAL库报错"></p>
<p>按照编译器的提示加冒号：和分号；简直是智障行为，肯定是函数有问题。</p>
<p>跳转到函数定义处，一段包含于<strong>stm32f1xx_hal_tim.h</strong>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIM_SET_CAPTUREPOLARITY(__HANDLE__, __CHANNEL__, __POLARITY__) \</span></span><br><span class="line">  (((__CHANNEL__) == TIM_CHANNEL_1) ? ((__HANDLE__)-&gt;Instance-&gt;CCER |= (__POLARITY__)) :\</span><br><span class="line">   ((__CHANNEL__) == TIM_CHANNEL_2) ? ((__HANDLE__)-&gt;Instance-&gt;CCER |= ((__POLARITY__) &lt;&lt; <span class="number">4U</span>)) :\</span><br><span class="line">   ((__CHANNEL__) == TIM_CHANNEL_3) ? ((__HANDLE__)-&gt;Instance-&gt;CCER |= ((__POLARITY__) &lt;&lt; <span class="number">8U</span>)) :\</span><br><span class="line">   ((__HANDLE__)-&gt;Instance-&gt;CCER |= (((__POLARITY__) &lt;&lt; <span class="number">12U</span>))))</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIM_RESET_CAPTUREPOLARITY(__HANDLE__, __CHANNEL__) \</span></span><br><span class="line">  (((__CHANNEL__) == TIM_CHANNEL_1) ? ((__HANDLE__)-&gt;Instance-&gt;CCER &amp;= ~(TIM_CCER_CC1P | TIM_CCER_CC1NP))) :\</span><br><span class="line">   ((__CHANNEL__) == TIM_CHANNEL_2) ? ((__HANDLE__)-&gt;Instance-&gt;CCER &amp;= ~(TIM_CCER_CC2P | TIM_CCER_CC2NP)) :\</span><br><span class="line">   ((__CHANNEL__) == TIM_CHANNEL_3) ? ((__HANDLE__)-&gt;Instance-&gt;CCER &amp;= ~(TIM_CCER_CC3P | TIM_CCER_CC3NP)) :\</span><br><span class="line">   ((__HANDLE__)-&gt;Instance-&gt;CCER &amp;= ~(TIM_CCER_CC4P))</span><br></pre></td></tr></table></figure>
<p>居然是个宏函数。。。按照报错提示，设置函数是没有问题的，但是清除函数有bug，才导致使用函数时异常报错。</p>
<p>我们参考正常的设置极性函数，比较一下清除极性函数问题在哪里：</p>
<p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://img-blog.csdnimg.cn/20200513204403956.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70" alt="bug"></p>
<p>问题一目了然了吧，就是这个括号的位置，应该放到函数最后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TIM_RESET_CAPTUREPOLARITY(__HANDLE__, __CHANNEL__) \</span></span><br><span class="line">  (((__CHANNEL__) == TIM_CHANNEL_1) ? ((__HANDLE__)-&gt;Instance-&gt;CCER &amp;= ~(TIM_CCER_CC1P | TIM_CCER_CC1NP)) :\</span><br><span class="line">   ((__CHANNEL__) == TIM_CHANNEL_2) ? ((__HANDLE__)-&gt;Instance-&gt;CCER &amp;= ~(TIM_CCER_CC2P | TIM_CCER_CC2NP)) :\</span><br><span class="line">   ((__CHANNEL__) == TIM_CHANNEL_3) ? ((__HANDLE__)-&gt;Instance-&gt;CCER &amp;= ~(TIM_CCER_CC3P | TIM_CCER_CC3NP)) :\</span><br><span class="line">   ((__HANDLE__)-&gt;Instance-&gt;CCER &amp;= ~(TIM_CCER_CC4P)))</span><br></pre></td></tr></table></figure>
<p>唉，听说HAL库还有很多bug呢，遇到一个收录一个吧，又要踩坑了哈哈哈。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="https://img-blog.csdnimg.cn/20200419121558948.jpg?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0NhcmJvbjY=,size_16,color_FFFFFF,t_70"
                alt="Silicon4" />
            
              <p class="site-author-name" itemprop="name">Silicon4</p>
              <p class="site-description motion-element" itemprop="description">Silicon4的个人博客</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">21</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/yourname" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="skype:yourname?call|chat" target="_blank" title="Skype">
                      
                        <i class="fa fa-fw fa-skype"></i>Skype</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Silicon4</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  







  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/canvas_lines.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight||document.documentElement.clientHeight)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>
</html>
